(function(){var t,e,r,i,n,o,u,a=function(t,e){return function(){return t.apply(e,arguments)}},s=[].indexOf||function(t){for(var e=0,r=this.length;e<r;e++)if(e in this&&this[e]===t)return e;return-1};ko.mapper.handlers.callback={fromJS:function(t,e,r,i){return null==r?e.$create(t):e.$update(t,r)},toJS:function(t,e){return t.toJS()}},ko.mapper.handlers.observe=ko.mapper.handlers.value,function(){var t,e,r;e=humanFormat.makePrefixes("y,z,a,f,p,n,Âµ,m,,k,M,G,T,P,E,Z,Y".split(","),1e3,-8),r=humanFormat.makePrefixes(",k".split(","),1e3,0),t=humanFormat.makePrefixes("m,c,d,".split(","),10,-3),humanFormat.unitPrefixes={B:e,W:r,Wh:r,m:t}}(),e=function(){function t(t,e){this.device=e,this.tooltipFormatter=a(this.tooltipFormatter,this),this.tooltipHtml=a(this.tooltipHtml,this),null==t.value&&(t.value=null),this.history=ko.observableArray([]),this.lastUpdate=ko.observable(0),ko.mapper.fromJS(t,this.constructor.mapping,this),this.unitText=null!=this.unit?this.unit:"","number"===this.type&&(this.sparklineHistory=ko.pureComputed(function(t){return function(){var e,r,i,n,o,u,a;for(o=[],e=0,r=(i=t.history()).length;e<r;e++)u=(n=i[e]).t,a=n.v,o.push([u,a]);return o}}(this)))}return t.mapping={$default:"ignore",description:"copy",label:"copy",acronym:"copy",labels:"copy",name:"copy",type:"copy",value:"observe",unit:"copy",history:"observe",lastUpdate:"observe",displaySparkline:"observe",displayUnit:"copy",discrete:"copy",icon:"copy",hidden:"copy"},t.prototype.shouldDisplaySparkline=function(){return"number"===this.type&&this.history().length>1&&(null==this.displaySparkline||null==this.displaySparkline()||this.displaySparkline())},t.prototype.tooltipHtml=function(){var t;return this.label+": "+this.formatValue(this.value())+" "+this.lastUpdateTimeText()+("number"===(t=this.type)||"boolean"===t?'<a href="#" id="to-graph-page"\n  data-attributeName="'+this.name+'"\n  data-deviceId="'+this.device.id+'">'+__("Graph")+"</a>":"")+'<a href="#" id="to-device-editor-page"\ndata-deviceId="'+this.device.id+'">'+__("Edit Device")+"</a>"},t.prototype.outOfDate=function(){var t,e;return"number"===this.type&&(e=(new Date).getTime(),t=this.lastUpdate(),e-t>18e5)},t.prototype.lastUpdateTimeText=function(){return" @ "+this.formatTime(this.lastUpdate())},t.prototype.tooltipFormatter=function(t,e,r){var i,n;return n=this.formatValue(r.y),i=this.formatTime(r.x),"<span>"+n+" @ "+i+"</span>"},t.prototype.update=function(t){return ko.mapper.fromJS(t,this.constructor.mapping,this)},t.prototype.updateValue=function(t,e){return this.value(e),this.lastUpdate(t),30===this.history().length&&this.history.shift(),this.history.push({t:t,v:e})},t.prototype.displayValueText=function(){var t;return null==(t=this.value())?__("unknown"):"number"===this.type?this._getNumberFormat(t).num:this.formatValue(t)},t.prototype.displayUnitText=function(){var t;return"number"===this.type?(t=this.value(),this._getNumberFormat(t).unit):""},t.prototype.shouldDisplayAcronym=function(){var t;return(null!=(t=this.acronym)?t.length:void 0)>0},t.prototype.displayAcronym=function(){return this.acronym||""},t.prototype.formatValue=function(t){var e;switch(this.type){case"boolean":return this.labels?!0===t?__(this.labels[0]):__(this.labels[1]):t.toString();case"string":return t;case"number":return(e=this._getNumberFormat(t)).num+" "+e.unit;default:return t.toString()}},t.prototype._getNumberFormat=function(t){var e,r,i,n,o,u;if(n=this.unit,s.call(Object.keys(humanFormat.unitPrefixes),n)>=0)return i=null!=this.displayUnit&&null!=this.unit?this.displayUnit.substring(0,this.displayUnit.length-this.unit.length):null,e=humanFormat.humanFormatInfo(t,{unit:this.unit,prefixes:humanFormat.unitPrefixes[this.unit],prefix:i}),"W"!==(o=e.unit)&&"Wh"!==o||"k"!==e.prefix?"m"===e.unit&&""===e.prefix&&t>=1e3&&(e.num=Math.round(t/100)/10,e.prefix="k"):(e.num=Math.round(t)/1e3,e.num=e.num.toFixed(3)),{num:e.num,unit:e.prefix+e.unit};if("kW"===(u=this.unit)||"kWh"===u)r=(r=Math.round(1e3*t)/1e3).toFixed(3);else{if("s"===this.unit)return r=pimatic.toHHMMSS(t),{num:r,unit:""};r=Math.round(100*t)/100}return{num:r,unit:this.unit||""}},t.prototype.shouldDisplayValue=function(){var t;return null!=(t=this.icon)?!t.noText:!0},t.prototype.shouldDisplayIcon=function(){return null!=this.icon&&null!=this.value()},t.prototype._getIconClass=function(t){var e,r,i,n;if(null==this.icon)return null;if(r=null,null!=this.icon.mapping){i=this.icon.mapping;for(e in i)if(n=i[e],$.isArray(n)&&2===n.length){if(n[0]<=t&&t<n[1]){r=e;break}}else if(n===t){r=e;break}}return null==r&&(r=this.icon.default),r},t.prototype.getIconClass=function(){return this._getIconClass(this.value())},t.prototype.formatTime=function(t){var e,r;return e=pimatic.timestampToDateTime(t),r=pimatic.timestampToDateTime(new Date),e.date!==r.date?e.date+" "+e.time:e.time},t.prototype.toJS=function(){return ko.mapper.toJS(this,this.constructor.mapping)},t}(),t=function(){function t(e){var r,i,n,o;for(t.mapping.device=this,ko.mapper.fromJS(e,this.constructor.mapping,this),this.configObserve=ko.observable(e.config),this.rest={},i=0,n=(o=this.actions).length;i<n;i++)r=o[i],pimatic.client.createRestAction(this.rest,r.name,r,{type:"get",url:"/api/device/"+this.id+"/"+r.name});this.group=ko.pureComputed(function(t){return function(){return"null"===t.id?null:pimatic.getGroupOfDevice(t.id)}}(this)),this.configWithDefaults=ko.pureComputed(function(t){return function(){var e,r,i,n,o;o={},i=t.configDefaults;for(r in i)e=i[r],o[r]=e;n=t.configObserve();for(r in n)e=n[r],o[r]=e;return o}}(this))}return t.mapping={$default:"ignore",name:"observe",config:"copy",configDefaults:"copy",id:"copy",template:"copy",actions:"copy",attributes:{$key:"name",$itemOptions:{$handler:"callback",$create:function(r){return new e(r,t.mapping.device)},$update:function(t,e){return e.update(t),e}}}},t.prototype.update=function(e){return t.mapping.device=this,ko.mapper.fromJS(e,this.constructor.mapping,this),this.configObserve(e.config)},t.prototype.toJS=function(){return ko.mapper.toJS(this,this.constructor.mapping)},t.prototype.getAttribute=function(t){return ko.utils.arrayFirst(this.attributes(),function(e){return e.name===t})},t.prototype.updateAttribute=function(t,e,r){var i;if(null!=(i=this.getAttribute(t)))return i.updateValue(e,r)},t.prototype.hasAttibuteWith=function(t){var e,r,i,n;for(r=0,i=(n=this.attributes()).length;r<i;r++)if(e=n[r],t(e))return!0;return!1},t}(),o=function(){function t(t){ko.mapper.fromJS(t,this.constructor.mapping,this),this.group=ko.pureComputed(function(t){return function(){return pimatic.getGroupOfRule(t.id)}}(this))}return t.mapping={$default:"ignore",id:"copy",name:"observe",string:"observe",actionsToken:"observe",conditionToken:"observe",error:"observe",active:"observe",logging:"observe",valid:"observe"},t.prototype.update=function(t){return ko.mapper.fromJS(t,this.constructor.mapping,this)},t.prototype.toJS=function(){return ko.mapper.toJS(this,this.constructor.mapping)},t}(),u=function(){function t(t){null==t.value&&(t.value=null),null==t.exprInputStr&&(t.exprInputStr=null),null==t.exprTokens&&(t.exprTokens=null),ko.mapper.fromJS(t,this.constructor.mapping,this),this.displayName=ko.pureComputed(function(t){return function(){return"$"+t.name}}(this)),this.hasValue=ko.pureComputed(function(t){return function(){return null!=t.value()}}(this)),this.displayValue=ko.pureComputed(function(t){return function(){return t.hasValue()?t.value():"null"}}(this)),this.group=ko.pureComputed(function(t){return function(){return pimatic.getGroupOfVariable(t.name)}}(this))}return t.mapping={$default:"ignore",exprInputStr:"observe",exprTokens:"observe",name:"copy",readonly:"observe",type:"observe",value:"observe",unit:"observe"},t.prototype.isDeviceAttribute=function(){return-1!==$.inArray(".",this.name)},t.prototype.update=function(t){return ko.mapper.fromJS(t,this.constructor.mapping,this)},t.prototype.toJS=function(){return ko.mapper.toJS(this,this.constructor.mapping)},t}(),r=function(){function t(t){ko.mapper.fromJS(t,this.constructor.mapping,this),this.deviceByGroups=ko.pureComputed(function(t){return function(){var e,r,i,n,o,u,a;for(u={$ungrouped:[]},n=0,o=(a=t.devices()).length;n<o;n++)(e=a[n]).device!==pimatic.nullDevice&&(null!=u[i=(null!=(r=pimatic.getGroupOfDevice(e.device.id))?r.id:void 0)||"$ungrouped"]?u[i].push(e):u[i]=[e]);return u}}(this))}return t.mapping={$default:"ignore",id:"copy",name:"observe",devices:{$key:"deviceId",$itemOptions:{$handler:"callback",$create:function(t){var e,r;return null==(e=pimatic.getDeviceById(t.deviceId))&&(e=pimatic.nullDevice),null==(r=pimatic.templateClasses[e.template])&&(console.warn("Could not find a template class for "+e.template),r=pimatic.DeviceItem),null==e?console.error("Device should never be null"):new r(t,e)},$update:function(t,e){return e.update(t),e}}}},t.prototype.getDevicesInGroup=function(t){return this.deviceByGroups()[t]||[]},t.prototype.getUngroupedDevices=function(){return this.deviceByGroups().$ungrouped},t.prototype.update=function(t){return ko.mapper.fromJS(t,this.constructor.mapping,this)},t.prototype.getDeviceTemplate=function(t){return t.getDeviceTemplate()},t.prototype.afterRenderDevice=function(t,e){return e.afterRender(t)},t.prototype.toJS=function(){return ko.mapper.toJS(this,this.constructor.mapping)},t}(),i=function(){function t(t){ko.mapper.fromJS(t,this.constructor.mapping,this),this.getDevices=ko.pureComputed(function(t){return function(){var e,r,i,n,o,u;for(i=[],n=0,o=(u=t.devices()).length;n<o;n++)e=u[n],null!=(r=pimatic.getDeviceById(e))&&i.push(r);return i}}(this)),this.getRules=ko.pureComputed(function(t){return function(){var e,r,i,n,o,u;for(u=[],e=0,r=(i=t.rules()).length;e<r;e++)n=i[e],null!=(o=pimatic.getRuleById(n))&&u.push(o);return u}}(this)),this.getVariables=ko.pureComputed(function(t){return function(){var e,r,i,n,o,u;for(u=[],e=0,r=(i=t.variables()).length;e<r;e++)n=i[e],null!=(o=pimatic.getVariableByName(n))&&u.push(o);return u}}(this))}return t.mapping={$default:"ignore",id:"copy",name:"observe",rules:"array",devices:"array",variables:"array"},t.prototype.update=function(t){return ko.mapper.fromJS(t,this.constructor.mapping,this)},t.prototype.getDevicesWithAttibute=function(t){var e;return function(){var r,i,n,o;for(o=[],r=0,i=(n=this.getDevices()).length;r<i;r++)(e=n[r]).hasAttibuteWith(t)&&o.push(e);return o}.call(this)},t.prototype.getDevicesWithGraphableAttribute=function(){return this.getDevicesWithAttibute(function(t){var e;return"number"===(e=t.type)||"boolean"===e})},t.prototype.containsDevice=function(t){return-1!==ko.utils.arrayIndexOf(this.devices(),t)},t.prototype.toJS=function(){return ko.mapper.toJS(this,this.constructor.mapping)},t}(),n=function(){function e(){this.isDemo=a(this.isDemo,this),this.hasPermission=a(this.hasPermission,this),window.pimatic=this,this.client=new DeclApiClient(api),this.updateFromJs({devices:[],rules:[],variables:[],devicepages:[],groups:[],errorCount:0,rememberme:!1,updateProcessStatus:"idle",updateProcessMessages:[],guiSettings:null,username:null,role:null,permissions:[{pages:"none",rules:"none",variables:"none",messages:"none",events:"none",devices:"none",groups:"none",plugins:"none",updates:"none"}]}),this.setupStorage(),this.updateProcessStatus.subscribe(function(t){switch(t){case"running":return pimatic.loading("update-process-status","show",{text:__("Installing updates, Please be patient")});default:return pimatic.loading("update-process-status","hide")}}),this.autosave=ko.computed(function(t){return function(){var e;if(t._dataLoaded())return e=t.toJS(),pimatic.storage.set("pimatic.scope",e)}}(this)).extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}}),this.rememberme.subscribe(function(t){var e;return e=pimatic.storage.get("pimatic"),pimatic.storage.removeAll(),pimatic.storage=t?$.localStorage:$.sessionStorage,e.scope.rememberMe=t,pimatic.storage.set("pimatic",e)}),this.getUngroupedDevices=ko.pureComputed(function(t){return function(){var e,r,i,n,o;for(o=[],r=0,i=(n=t.devices()).length;r<i;r++)null==(e=n[r]).group()&&o.push(e);return o}}(this))}return e.mapping={$default:"ignore",devices:{$key:"id",$itemOptions:{$handler:"callback",$create:function(e){return new t(e)},$update:function(t,e){return e.update(t),e}}},rules:{$key:"id",$itemOptions:{$handler:"callback",$create:function(t){return new o(t)},$update:function(t,e){return e.update(t),e}}},variables:{$key:"name",$itemOptions:{$handler:"callback",$create:function(t){return new u(t)},$update:function(t,e){return e.update(t),e}}},devicepages:{$key:"id",$itemOptions:{$handler:"callback",$create:function(t){return new r(t)},$update:function(t,e){return e.update(t),e}}},groups:{$key:"id",$itemOptions:{$handler:"callback",$create:function(t){return new i(t)},$update:function(t,e){return e.update(t),e}}},errorCount:"observe",rememberme:"observe",updateProcessStatus:"observe",updateProcessMessages:"array",guiSettings:"observe",username:"observe",role:"observe",permissions:"observe"},e.prototype.socket=null,e.prototype.inited=!1,e.prototype.pages={},e.prototype.storage=null,e.prototype._dataLoaded=ko.observable(!1),e.prototype.nullDevice=new t({id:"null",name:"null",attributes:[],actions:[],template:"null"}),e.prototype.loadDataFromStorage=function(){var t,e;if(this._dataLoaded(!0),pimatic.storage.isSet("pimatic.scope")){t=pimatic.storage.get("pimatic.scope");try{return this.updateFromJs(t)}catch(t){return e=t,TraceKit.report(e),pimatic.storage.removeAll(),window.location.reload()}}},e.prototype.updateFromJs=function(t){return ko.mapper.fromJS(t,e.mapping,this)},e.prototype.toJS=function(){return ko.mapper.toJS(this,e.mapping)},e.prototype.setupStorage=function(){return $.localStorage.isSet("pimatic")?(pimatic.storage=$.localStorage,$.sessionStorage.removeAll(),this.rememberme(!0)):$.sessionStorage.isSet("pimatic")?(pimatic.storage=$.sessionStorage,$.localStorage.removeAll(),this.rememberme(!1)):(pimatic.storage=$.sessionStorage,this.rememberme(!1),pimatic.storage.set("pimatic",{}))},e.prototype.getDeviceById=function(t){return ko.utils.arrayFirst(this.devices(),function(e){return e.id===t})},e.prototype.getGroupOfDevice=function(t){var e,r,i,n;for(r=0,i=(n=this.groups()).length;r<i;r++)if(e=n[r],-1!==ko.utils.arrayIndexOf(e.devices(),t))return e;return null},e.prototype.updateDeviceAttribute=function(t,e,r,i){var n,o,u,a,s;for(s=[],o=0,u=(a=this.devices()).length;o<u;o++){if((n=a[o]).id===t){n.updateAttribute(e,r,i);break}s.push(void 0)}return s},e.prototype.updateDeviceFromJs=function(t){var r;return null==(r=this.getDeviceById(t.id))?(r=e.mapping.devices.$itemOptions.$create(t),this.devices.push(r)):r.update(t)},e.prototype.updateDeviceOrder=function(t){var e;return e=function(e){var r;return-1===(r=$.inArray(e,t))?999999:r},this.devices.sort(function(t,r){return e(t.id)-e(r.id)})},e.prototype.removeDevice=function(t){return this.devices.remove(function(e){return e.id===t})},e.prototype.getPageById=function(t){return ko.utils.arrayFirst(this.devicepages(),function(e){return e.id===t})},e.prototype.removePage=function(t){return this.devicepages.remove(function(e){return e.id===t})},e.prototype.updatePageFromJs=function(t){var r;return null==(r=this.getPageById(t.id))?(r=e.mapping.devicepages.$itemOptions.$create(t),this.devicepages.push(r)):r.update(t)},e.prototype.updatePageOrder=function(t){var e;return e=function(e){var r;return-1===(r=$.inArray(e,t))?999999:r},this.devicepages.sort(function(t,r){return e(t.id)-e(r.id)})},e.prototype.getGroupById=function(t){return ko.utils.arrayFirst(this.groups(),function(e){return e.id===t})},e.prototype.removeGroup=function(t){return this.groups.remove(function(e){return e.id===t})},e.prototype.updateGroupFromJs=function(t){var r;return null==(r=this.getGroupById(t.id))?(r=e.mapping.groups.$itemOptions.$create(t),this.groups.push(r)):r.update(t)},e.prototype.getGroupOfRule=function(t){var e,r,i,n;for(r=0,i=(n=this.groups()).length;r<i;r++)if(e=n[r],-1!==ko.utils.arrayIndexOf(e.rules(),t))return e;return null},e.prototype.updateGroupOrder=function(t){var e;return e=function(e){var r;return-1===(r=$.inArray(e,t))?999999:r},this.groups.sort(function(t,r){return e(t.id)-e(r.id)})},e.prototype.getRuleById=function(t){return ko.utils.arrayFirst(this.rules(),function(e){return e.id===t})},e.prototype.removeRule=function(t){return this.rules.remove(function(e){return e.id===t})},e.prototype.updateRuleFromJs=function(t){var r;return null==(r=this.getRuleById(t.id))?(r=e.mapping.rules.$itemOptions.$create(t),this.rules.push(r)):r.update(t)},e.prototype.updateRuleOrder=function(t){var e;return e=function(e){var r;return-1===(r=$.inArray(e,t))?999999:r},this.rules.sort(function(t,r){return e(t.id)-e(r.id)})},e.prototype.removeVariable=function(t){return this.variables.remove(function(e){return e.name===t})},e.prototype.getVariableByName=function(t){return ko.utils.arrayFirst(this.variables(),function(e){return e.name===t})},e.prototype.updateVariableValue=function(t,e){var r;if(null!=(r=this.getVariableByName(t)))return r.value(e)},e.prototype.updateVariableFromJs=function(t){var r;return null==(r=this.getVariableByName(t.name))?(r=e.mapping.variables.$itemOptions.$create(t),this.variables.push(r)):r.update(t)},e.prototype.updateVariableOrder=function(t){var e;return e=function(e){var r;return-1===(r=$.inArray(e,t))?999999:r},this.variables.sort(function(t,r){return e(t.name)-e(r.name)})},e.prototype.getGroupOfVariable=function(t){var e,r,i,n;for(r=0,i=(n=this.groups()).length;r<i;r++)if(e=n[r],-1!==ko.utils.arrayIndexOf(e.variables(),t))return e;return null},e.prototype.hasPermission=function(t,e){var r;switch(r=this.permissions()[t],e){case"read":return"read"===r||"write"===r;case"write":return"write"===r;default:return!1}},e.prototype.isDemo=function(){var t;return null!=(t=this.guiSettings())?t.demo:void 0},e}(),window.pimatic=new n,window.pimatic.Device=t,window.pimatic.Rule=o,window.pimatic.Group=i,window.pimatic.Variable=u,window.pimatic.DevicePage=r,$(document).on("templateready",function(t){pimatic._dataLoaded()||pimatic.loadDataFromStorage()})}).call(this);