!function(t){"use strict";var e=function(t){var e,n;return e=function(){n=!1},function(){var s;n||(n=!0,(s=i(arguments)).unshift(e),t.apply(this,s))}},i=function(t){return Array.prototype.slice.call(t)},n=function(t,e){return t.bind?t.bind(e):function(){t.apply(e,arguments)}},s=void 0!==t("<div></div>").css(["color"]).color?function(t,e){return t.css(e)}:function(e,i){var n;return n={},t.each(i,function(t,i){n[i]=e.css(i)}),n},o=function(t){return t},a=function(t){var e={};return function(i,n){e[i]?n(e[i]):t.call(this,i,function(t){e[i]=(e[i]||[]).concat(t),n.apply(null,arguments)})}},l=function(t,e){var i,n;if(t.indexOf)return-1!=t.indexOf(e);for(i=0,n=t.length;i<n;i++)if(t[i]===e)return!0;return!1},r=function(){function i(e,i){var s,o,a;o=r.clone(),this.el=e.get(0),this.$el=e,s=c(this.$el),a=this.el===document.activeElement,this.$el.wrap(s).before(o),a&&this.el.focus(),this.listView=new h(o,this),this.strategies=i,this.$el.on("keyup",n(this.onKeyup,this)),this.$el.on("keydown",n(this.listView.onKeydown,this.listView)),t(document).on("click",n(function(t){t.originalEvent&&!t.originalEvent.keepTextCompleteDropdown&&this.listView.deactivate()},this))}var o,a,l,r;a={wrapper:{position:"relative"},list:{position:"absolute",top:0,left:0,zIndex:"100",display:"none"}},l=t((o={wrapper:'<div class="textcomplete-wrapper"></div>',list:'<div class="dropdown-menu"><ul class="format"></ul><ul class="autocomplete"></ul></div>'}).wrapper).css(a.wrapper),r=t(o.list).css(a.list),t.extend(i.prototype,{renderList:function(t,e,i){this.listView.clear(),this.lastData=i,i.autocomplete=this.filterData(t,i.autocomplete),(i.autocomplete.length||i.format.length)&&(this.listView.setPosition(this.getCaretPosition(t,e,i.autocomplete)),this.listView.shown||(this.listView.clear().activate(),this.listView.strategy=this.strategy),this.listView.render(i)),this.listView.data.autocomplete.length||this.listView.data.format.length||!this.listView.shown||this.listView.deactivate()},searchCallbackFactory:function(t,e){var i=this,n=i.getTextFromHeadToCaret();return function(s,o){i.renderList(t,n,s),o||(e(),i.clearAtNext=!0,i.onKeyup())}},onKeyup:function(t,e){var i,n;if((i=this.extractSearchQuery(this.getTextFromHeadToCaret())).length){if(n=i[1],!e&&this.term===n)return;this.search(i)}else this.term=null,this.listView.deactivate()},onSelect:function(t){var e,i,n;e=this.getTextFromHeadToCaret(),i=this.el.value.substring(this.el.selectionEnd),n=(e=this.strategy.replace(e,t))+i,this.el.value=n,this.el.focus(),this.strategy.change(n),this.el.selectionStart=this.el.selectionEnd=e.length,this.onKeyup(null,!0)},getCommonPart:function(t,e){var i,n;for(i=Math.min(t.length,e.length);i>=0&&(n=e.substring(0,i),t.toLowerCase().lastIndexOf(n.toLowerCase())!==t.length-n.length);)i--;return e.substring(0,i)},getCaretPosition:function(e,i,n){var o,a,l,r,h,i;o=["border-width","font-family","font-size","font-style","font-variant","font-weight","height","letter-spacing","word-spacing","line-height","text-decoration","text-align","width","padding-top","padding-right","padding-bottom","padding-left","margin-top","margin-right","margin-bottom","margin-left"],a=t.extend({position:"absolute",overflow:"auto","white-space":"pre-wrap",top:0,left:-9999},s(this.$el,o));var c=function(t){if(0===t.length)return"";for(var e=t[0],i=e.length,n=1;n<t.length&&i>0;n++){for(var s=t[n],o=0,a=Math.min(s.length,i);++o<a&&s.charAt(o).toLowerCase()==e.charAt(o).toLowerCase(););i=o}return e.substring(0,i)}(n),u=this.getCommonPart(i,c);return i.length>=u.length&&(i=i.substring(0,i.length-u.length)),l=t("<div></div>").css(a).text(i),r=t("<span></span>").text("&nbsp;").appendTo(l),this.$el.before(l),h=r.position(),h.top+=r.height()-this.$el.scrollTop(),l.remove(),h},getTextFromHeadToCaret:function(){var t,e,i;return"number"==typeof(e=this.el.selectionEnd)?t=this.el.value.substring(0,e):document.selection&&((i=this.el.createTextRange()).moveStart("character",0),i.moveEnd("textedit"),t=i.text),t},filterData:function(t,e){var i=this.getTextFromHeadToCaret(),n=i.substring(t.length,i.length);if(n.lenght>0){for(var s=[],o=0;o<e.length;o++)e[o].substring(0,n.lenght)===n&&s.push(e[o]);return s}return e},extractSearchQuery:function(t){var e,i,n,s;for(e=0,i=this.strategies.length;e<i;e++)if(n=this.strategies[e],n.ac=this,s=t.match(n.match))return[n,s[n.index]];return[]},search:function(t){var e;return this.strategy=t[0],e=t[1],this.searchOnline(e)},searchOnline:e(function(t,e){this.term=e,this.strategy.search(e,this.searchCallbackFactory(e,t))})});var c=function(t){return l.clone().css("display",t.css("display"))};return i}(),h=function(){function e(t,e){this.data={autocomplete:[],format:[]},this.$el=t,this.index=0,this.completer=e,this.$el.on("click","li.textcomplete-item",n(this.onClick,this)),this.$el.on("change","select",n(this.onChange,this))}return t.extend(e.prototype,{shown:!1,render:function(t){var e,i,n,s,o,a=this.strategy.maxCount;if(t.autocomplete.length>this.strategy.maxCount&&a--,this.data.format=t.format,t.format.length){for(e="",i=0,n=t.format.length;i<n;i++)e+='<li class="textcomplete-item textcomplete-format">',e+=o=t.format[i],e+="</li>";this.$el.find(".format").append(e)}for(e="",i=0,n=t.autocomplete.length;i<n&&(o=t.autocomplete[i],l(this.data.autocomplete,o)||(s=this.data.autocomplete.length,this.data.autocomplete.push(o),e+='<li class="textcomplete-item" data-index="'+s+'"><a>',e+=this.strategy.template(o),e+="</a></li>",this.data.autocomplete.length!==a));i++);if(this.displayCount=this.data.autocomplete.length,t.autocomplete.length>a){for(e+='<li class="textcomplete-more" data.autocomplete-index="'+a+'">',e+="<select>",e+='<option value="more">...</option>',i=a,n=t.autocomplete.length;i<n;i++)o=t.autocomplete[i],l(this.data.autocomplete,o)||(s=this.data.autocomplete.length,this.data.autocomplete.push(o),e+='<option data-index="'+s+'" value="'+s+'">'+o+"</option>");e+='</select">',e+="</li>",this.displayCount++}this.$el.find(".autocomplete").append(e),0===this.data.autocomplete.length&&0===t.format.length?this.deactivate():this.data.autocomplete.length?this.activateIndexedItem():this.reposition()},clear:function(){return this.data.autocomplete=[],this.data.format=[],this.$el.find(".autocomplete").html(""),this.$el.find(".format").html(""),this.index=0,this},activateIndexedItem:function(){this.$el.find(".active").removeClass("active"),this.getActiveItem().addClass("active"),this.reposition()},getActiveItem:function(){return t(this.$el.find(".autocomplete").children().get(this.index))},activate:function(){return this.shown||(this.$el.show(),this.shown=!0),this},deactivate:function(){return this.shown&&(this.$el.hide(),this.shown=!1,this.data={autocomplete:[],format:[]},this.index=null),this},setPosition:function(t){return this.$el.css(t),this},select:function(t){this.completer.onSelect(this.data.autocomplete[t]),this.deactivate()},reposition:function(){var e=t(".textcomplete-wrapper"),i=this.$el.offset().left+this.$el.outerWidth(),n=(this.$el.offset().top,this.$el.outerHeight(),e.offset().left+e.outerWidth());e.offset().left,e.outerWidth();if(i>n){var s=i-n,o=parseInt(this.$el.css("left").replace("px",""),10);this.$el.css("left",o-s)}},onKeydown:function(t){if(this.shown)if(27===t.keyCode)this.deactivate();else if(38===t.keyCode)t.preventDefault(),0===this.index?this.index=this.displayCount-1:this.index-=1,this.activateIndexedItem();else if(40===t.keyCode)t.preventDefault(),this.index===this.displayCount-1?this.index=0:this.index+=1,this.activateIndexedItem();else if(13===t.keyCode||9===t.keyCode){var e=this.getActiveItem(),i=parseInt(e.data("index"));e.hasClass("textcomplete-more")?e.find("select").focus():(t.preventDefault(),this.select(i))}},onClick:function(e){var i=t(e.target);e.originalEvent.keepTextCompleteDropdown=!0,i.hasClass("textcomplete-item")||(i=i.parents("li.textcomplete-item")),this.select(parseInt(i.data("index")))},onChange:function(e){var i=t(e.target);this.select(parseInt(i.val()))}}),e}();t.fn.textcomplete=function(t){var e,i,n;for(e=0,i=t.length;e<i;e++)(n=t[e]).template||(n.template=o),null==n.index&&(n.index=2),n.cache&&(n.search=a(n.search)),n.maxCount||(n.maxCount=10);return new r(this,t),this}}(window.jQuery||window.Zepto);