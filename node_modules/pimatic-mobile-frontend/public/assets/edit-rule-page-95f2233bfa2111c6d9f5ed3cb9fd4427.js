(function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r=[].indexOf||function(t){for(var e=0,r=this.length;e<r;e++)if(e in this&&this[e]===t)return e;return-1};t=Array.prototype.concat,LazyLoad.js(t.apply(scripts.textcomplete)),$(document).on("pagecreate","#edit-rule-page",function(t){var i,n,s;if(null==pimatic.pages.editRule){i=function(){function t(t){this.ruleView=t,this.elementOptionsText=e(this.elementOptionsText,this),this.remove=e(this.remove,this),this.cancel=e(this.cancel,this),this.ok=e(this.ok,this),this.showDefaultSelection=e(this.showDefaultSelection,this),this.getElements=e(this.getElements,this),this.selectPredicate=e(this.selectPredicate,this),this.keypress=e(this.keypress,this),this.setInputValue=e(this.setInputValue,this),this.computedPredicateToken=ko.computed(function(t){return function(){var e,r,i,n;for(n="",t.justTrigger()&&(n+="trigger: "),e=0,r=(i=t.elements()).length;e<r;e++)n+=i[e].match();return n}}(this)),this.computedToken=ko.computed(function(t){return function(){var e,r,i,n;if(n=t.computedPredicateToken(),t.forEnabled())for(e=0,r=(i=t.forElements()).length;e<r;e++)n+=i[e].match();return n}}(this)),this.computedToken.subscribe(this.setInputValue),this.inputValue.subscribe(function(t){return function(e){if(!t.dontUpdate)return t.disableElementsInput(!0),clearTimeout(t._getElments),t._getElments=setTimeout(function(){return t.getElements(e,null,"input changed")},2e3)}}(this))}return t.prototype.visible=ko.observable(!1),t.prototype.presets=ko.observable([]),t.prototype.elements=ko.observable([]),t.prototype.forElements=ko.observable([]),t.prototype.presetsVisible=ko.observable(!0),t.prototype.elementsVisible=ko.observable(!0),t.prototype.forElementsVisible=ko.observable(!0),t.prototype.forEnabled=ko.observable(!1),t.prototype.parentOp=null,t.prototype.side="left",t.prototype.errors=ko.observable(!0),t.prototype.inputValue=ko.observable(!0),t.prototype.disablePredicateInput=ko.observable(!1),t.prototype.disableElementsInput=ko.observable(!1),t.prototype.justTrigger=ko.observable(!1),t.prototype.canRemove=ko.observable(!1),t.prototype.setInputValue=function(t){return this.dontUpdate=!0,this.inputValue(t),this.dontUpdate=!1},t.prototype.keypress=function(t,e){return 13!==e.keyCode||(this.parse(this.inputValue(),!0),!1)},t.prototype.parse=function(t){return pimatic.client.rest.getRuleConditionHints({conditionInput:t}).done(function(t){return function(e){return e.success&&null!=e.hints.tree?(e.hints.tree.parent=t.parentOp,t.updateTree(e.hints.tree),t.visible(!1)):(t.errors(e.hints.errors),swal("Oops...",__(e.hints.errors[0]),"error"))}}(this))},t.prototype.refreshPresets=function(){return pimatic.client.rest.getPredicatePresets({}).done(function(t){return function(e){if(e.success&&null!=e.presets)return t.presets(e.presets)}}(this))},t.prototype.updateTree=function(t){if(null==this.parentOp)return this.ruleView.tree(t);if(!this.side)throw new Error("illegal side: ",this.side);return this.parentOp[this.side]=t,this.ruleView.tree.valueHasMutated()},t.prototype.selectPredicate=function(t){return this.setInputValue(t.input),this.getElements(t.input,t.predicateProviderClass,"selectPredicate")},t.prototype.getElements=function(t,e,r){return 0===this.inputValue().length?this.showDefaultSelection():(this.disableElementsInput(!0),this.disablePredicateInput(!0),pimatic.client.rest.getPredicateInfo({input:t,predicateProviderClass:e}).done(function(t){return function(e){var r,i;if(e.success)return null!=e.result.predicate&&(t.justTrigger(e.result.predicate.justTrigger),r=e.result.elements,0===t.elements().length&&null==r&&(r=[{match:e.result.predicate.token,type:"text"}]),0===e.result.errors.length&&null!=r&&t.showElementSelection(r,e.result.forElements,null!=(null!=(i=e.result.predicate)?i.for:void 0))),t.errors(e.result.errors||[])}}(this)).always(function(t){return function(){return t.disableElementsInput(!1),t.disablePredicateInput(!1)}}(this)))},t.prototype.showDefaultSelection=function(){return this.presetsVisible(!0),this.elementsVisible(!1),this.forElementsVisible(!1),0===this.presets().length&&this.refreshPresets(),this.disableElementsInput(!1),this.disablePredicateInput(!1)},t.prototype.showElementSelection=function(t,e,i){var n,s,o,a,l,p,u,h,c;if(this.presetsVisible(!1),this.elementsVisible(!0),this.forEnabled(i),h=function(t){var e,r,i;for(r=0,i=t.length;r<i;r++)e=t[r],ko.isObservable(e.match)||(e.wildcardMatch&&"text"!==e.type?e.match=ko.observable(e.wildcard):e.match=ko.observable(e.match));return t},null!=this.eleSubscriptions)for(a=0,p=(c=this.eleSubscriptions).length;a<p;a++)c[a].dispose();for(this.eleSubscriptions=[],h(t),o=!1,n=function(e){return function(i,n){return e.eleSubscriptions.push(n.match.subscribe(function(n){var s,a,l,p;if(!o){for(o=!0,t=e.elements(),a=i+1;a<t.length;)null!=(s=t[a]).wildcard&&(null!=s.options&&(l=s.wildcard,r.call(s.options,l)<0&&s.options.unshift(s.wildcard)),s.match(s.wildcard)),a++;return o=!1,clearTimeout(e._getElments),p="select"===t[i].type?100:2e3,e._getElments=setTimeout(function(){return e.getElements(e.computedToken(),null,"element changed")},p)}}))}}(this),s=l=0,u=t.length;l<u;s=++l)n(s,t[s]);return this.elements(t),null!=e?this.forElements(h(e)):this.forElements([]),this.forElementsVisible(null!=e)},t.prototype.showEmpty=function(t){if(this.side="right",this.parentOp=t,this.visible(!0),this.setInputValue(""),this.refreshPresets(),this.showDefaultSelection(),this.justTrigger(!1),this.canRemove(!1),!("ontouchstart"in window||navigator.msMaxTouchPoints))return $("#rule-condition-input").focus()},t.prototype.editPredicate=function(t){var e;return this.side=(null!=(e=t.parent)?e.left:void 0)===t?"left":"right",this.parentOp=t.parent,this.visible(!0),this.canRemove(!0),this.setInputValue(this.ruleView.predicateToString(t.predicate)),this.getElements(this.inputValue())},t.prototype.ok=function(){return this.parse(this.inputValue(),!0)},t.prototype.cancel=function(){return null!=this.parentOp&&null===this.parentOp[this.side]&&(null!=this.parentOp.parent?("left"===this.side?this.parentOp.parent.left===this.parentOp?(this.parentOp.parent.left=this.parentOp.right,this.parentOp.parent.left.parent=this.parentOp.parent):this.parentOp.parent.right===this.parentOp&&(this.parentOp.parent.right=this.parentOp.right,this.parentOp.parent.right.parent=this.parentOp.parent):this.parentOp.parent.left===this.parentOp?(this.parentOp.parent.left=this.parentOp.left,this.parentOp.parent.left.parent=this.parentOp.parent):this.parentOp.parent.right===this.parentOp&&(this.parentOp.parent.right=this.parentOp.left,this.parentOp.parent.right.parent=this.parentOp.parent),this.ruleView.tree.valueHasMutated()):"left"===this.side?(this.parentOp.right.parent=void 0,this.ruleView.tree(this.parentOp.right)):(this.parentOp.left.parent=void 0,this.ruleView.tree(this.parentOp.left))),this.visible(!1)},t.prototype.remove=function(){return null!=this.parentOp?(null!=this.parentOp.parent?"left"===this.side?this.parentOp.parent.left===this.parentOp?(this.parentOp.parent.left=this.parentOp.right,this.parentOp.parent.left.parent=this.parentOp.parent):this.parentOp.parent.right===this.parentOp&&(this.parentOp.parent.right=this.parentOp.right,this.parentOp.parent.right.parent=this.parentOp.parent):this.parentOp.parent.left===this.parentOp?(this.parentOp.parent.left=this.parentOp.left,this.parentOp.parent.left.parent=this.parentOp.parent):this.parentOp.parent.right===this.parentOp&&(this.parentOp.parent.right=this.parentOp.left,this.parentOp.parent.right.parent=this.parentOp.parent):"left"===this.side?(this.parentOp.right.parent=void 0,this.ruleView.tree(this.parentOp.right)):(this.parentOp.left.parent=void 0,this.ruleView.tree(this.parentOp.left)),this.ruleView.tree.valueHasMutated()):this.ruleView.tree(null),this.visible(!1)},t.prototype.elementOptionsText=function(t){return t.replace(/^\{(.*)\}$/,"Choose $1...")},t}(),n=function(){function t(){this.saveEditMode=e(this.saveEditMode,this),this.setGuiMode=e(this.setGuiMode,this),this.setTextMode=e(this.setTextMode,this),this.addOrWhen=e(this.addOrWhen,this),this.addOr=e(this.addOr,this),this.addAndIf=e(this.addAndIf,this),this.addAnd=e(this.addAnd,this),this.editPredicate=e(this.editPredicate,this),this.addCondition=e(this.addCondition,this),this.ruleAsText=ko.computed(function(t){return function(){return"text"===t.editMode()?"when "+t.ruleCondition()+" then "+t.ruleActions():"when "+t.getTreeAsString()+" then "+t.ruleActions()}}(this)),this.pageTitle=ko.computed(function(t){return function(){return"add"===t.action()?__("Add new rule"):__("Edit rule")}}(this)),pimatic.autoFillId(this.ruleName,this.ruleId,this.action),this.conditionInput=new i(this)}return t.prototype.autocompleteAjax=null,t.prototype.autocompleEnabled=!0,t.prototype.action=ko.observable("add"),t.prototype.ruleId=ko.observable(""),t.prototype.ruleName=ko.observable(""),t.prototype.ruleCondition=ko.observable(""),t.prototype.ruleActions=ko.observable(""),t.prototype.ruleEnabled=ko.observable(!0),t.prototype.ruleLogging=ko.observable(!0),t.prototype.tree=ko.observable(null),t.prototype.editMode=ko.observable("text"),t.prototype.resetFields=function(){return this.ruleId(""),this.ruleName(""),this.ruleCondition(""),this.ruleActions(""),this.ruleEnabled(!0),this.ruleLogging(!0)},t.prototype.addCondition=function(){return this.conditionInput.showEmpty(null)},t.prototype.editPredicate=function(t){return this.conditionInput.editPredicate(t)},t.prototype.addAnd=function(t){return this.addBinaryOp("and",t)},t.prototype.addAndIf=function(t){return this.addBinaryOp("and if",t)},t.prototype.addOr=function(t){return this.addBinaryOp("or",t)},t.prototype.addOrWhen=function(t){return this.addBinaryOp("or when",t)},t.prototype.addBinaryOp=function(t,e){var r;return r={type:t,left:e,right:null},null!=e.parent?(e.parent.left===e?e.parent.left=r:e.parent.right=r,r.parent=e.parent,e.parent=r,this.tree.valueHasMutated()):(e.parent=r,this.tree(r)),this.conditionInput.showEmpty(r)},t.prototype.onSubmit=function(){var t;{if(pimatic.isValidId(this.ruleId()))return t={ruleId:this.ruleId(),rule:{ruleString:this.ruleAsText(),active:this.ruleEnabled(),name:this.ruleName(),logging:this.ruleLogging()}},function(){switch(this.action()){case"add":return pimatic.client.rest.addRuleByString(t);case"update":return pimatic.client.rest.updateRuleByString(t);default:throw new Error("Illegal rule action: "+this.action())}}.call(this).done(function(t){return t.success?$.mobile.changePage("#rules-page",{transition:"slide",reverse:!0}):alert(t.error)}).fail(ajaxAlertFail),!1;alert(__(pimatic.invalidIdMessage))}},t.prototype.onRemove=function(){return confirm(__("Do you really want to delete the %s rule?",this.ruleName()))&&pimatic.client.rest.removeRule({ruleId:this.ruleId()}).done(function(t){return t.success?$.mobile.changePage("#rules-page",{transition:"slide",reverse:!0}):alert(t.error)}).fail(ajaxAlertFail),!1},t.prototype.onCopy=function(){var t,e,r,i;return r=this.ruleId(),i=this.ruleName(),this.action("add"),null!=(t=i.match(/.*?([0-9]+)$/))?(e=t[1],this.ruleName(i.substring(0,i.length-e.length-1)+(parseInt(e,10)+1))):this.ruleName(i+" 2"),null!=(t=r.match(/.*?([0-9]+)$/))?(e=t[1],this.ruleId(r.substring(0,r.length-e.length-1)+(parseInt(e,10)+1))):this.ruleId(r+"-2")},t.prototype.predicateToString=function(t){var e;return e=t.justTrigger?"trigger: ":"",e+=t.token,null!=t.for&&(e+=" for "+t.for.token),e},t.prototype.getTreeAsString=function(){var t,e;return null==(e=this.tree())?"":(t=function(e){return function(r,i){var n,s;if(null==r)return"";switch(r.type){case"predicate":return e.predicateToString(r.predicate);default:return s=t(r.left,r)+" "+r.type+" "+t(r.right,r),null!=i&&i.type!==r.type&&!("and if"===(n=i.type)||"or when"===n)?"["+s+"]":s}}}(this))(e)},t.prototype.setTextMode=function(){return this.ruleCondition(this.getTreeAsString()),this.editMode("text"),this.saveEditMode("text")},t.prototype.setGuiMode=function(){var t;return t=function(e,r){return e.parent=r,null!=e.left&&t(e.left,e),null!=e.right&&t(e.right,e),e},pimatic.client.rest.getRuleConditionHints({conditionInput:this.ruleCondition()},{global:!0}).done(function(e){return function(r){if(r.success)return 0===r.hints.errors.length?(null!=r.hints.tree?e.tree(t(r.hints.tree)):e.tree(null),e.editMode("gui"),e.saveEditMode("gui")):swal("Oops...",__(r.hints.errors[0]),"error")}}(this)).fail(ajaxAlertFail)},t.prototype.saveEditMode=function(t){var e;return e=pimatic.storage.get("pimatic.editRule")||{},e.editMode=t,pimatic.storage.set("pimatic.editRule",e)},t}();try{pimatic.pages.editRule=new n}catch(t){s=t,TraceKit.report(s)}}}),$(document).on("pagecreate","#edit-rule-page",function(t){var e,r,i,n;try{return ko.applyBindings(pimatic.pages.editRule,$("#edit-rule-page")[0]),e=function(t,e){var r;return r=this.ac.getCommonPart(t,e),t.substring(0,t.length-r.length)+e},r=function(t){var e,r;return e=this.ac.getCommonPart(this.lastTerm,t),r=t.substring(e.length,t.length),"<strong>"+e+"</strong>"+r},n=pimatic.pages.editRule,$("#edit-rule-condition").textcomplete([{match:/^(.*)$/,search:function(t,e){var r,i;return null!=(r=n.autocompleteAjax)&&r.abort(),i={autocomplete:[],format:[]},pimatic.pages.editRule.autocompleEnabled?n.autocompleteAjax=pimatic.client.rest.getRuleConditionHints({conditionInput:t},{global:!1}).done(function(r){return function(n){var s,o;return i.autocomplete=(null!=(s=n.hints)?s.autocomplete:void 0)||[],i.format=(null!=(o=n.hints)?o.format:void 0)||[],n.error&&console.log(n.error),r.lastTerm=t,e(i)}}(this)).fail(function(){return e(i)}):e(i)},index:1,replace:function(t,r){var i;return i=e.call(this,t,r),n.ruleCondition(i),i},change:function(t){return n.ruleCondition(t)},template:r}]),$("#edit-rule-actions").textcomplete([{match:/^(.*)$/,search:function(t,e){var r,i;return i={autocomplete:[],format:[]},pimatic.pages.editRule.autocompleEnabled?(null!=(r=n.autocompleteAjax)&&r.abort(),n.autocompleteAjax=pimatic.client.rest.getRuleActionsHints({actionsInput:t},{global:!1}).done(function(r){return function(n){var s,o;return i.autocomplete=(null!=(s=n.hints)?s.autocomplete:void 0)||[],i.format=(null!=(o=n.hints)?o.format:void 0)||[],null!=n.message&&n.message.length>0&&pimatic.showToast(n.message[0]),n.error&&console.log(n.error),r.lastTerm=t,e(i)}}(this)).fail(function(){return e(i)})):e(i)},index:1,replace:function(t,r){var i;return i=e.call(this,t,r),n.ruleActions(i),i},change:function(t){return n.ruleActions(t)},template:r}])}catch(t){return i=t,TraceKit.report(i)}}),$(document).on("pagebeforehide","#edit-rule-page",function(t){var e,r;try{return null!=(r=pimatic.pages.editRule.autocompleteAjax)?r.abort():void 0}catch(t){return e=t,TraceKit.report(e)}}),$(document).on("pagebeforeshow","#edit-rule-page",function(t){var e,r,i,n,s;switch(e=pimatic.storage.get("pimatic.editRule")||{},r=pimatic.pages.editRule,i=jQuery.mobile.pageParams,jQuery.mobile.pageParams={},null!=i?(e.params={action:i.action,ruleId:null!=(n=i.rule)?n.id:void 0},pimatic.storage.set("pimatic.editRule",e)):null!=e.params&&null==(i={action:e.params.action,rule:pimatic.getRuleById(e.params.ruleId)}).rule&&(i.action="add"),"update"===(null!=i?i.action:void 0)?(s=i.rule,r.action("update"),r.ruleId(s.id),r.ruleName(s.name()),r.ruleCondition(s.conditionToken()),r.ruleActions(s.actionsToken()),r.ruleEnabled(s.active()),r.ruleLogging(s.logging())):(r.resetFields(),r.action("add"),r.ruleEnabled(!0)),e.editMode||"gui"){case"gui":r.setGuiMode();break;case"text":r.editMode("text")}})}).call(this);