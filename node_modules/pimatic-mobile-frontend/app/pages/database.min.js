(function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}};t=pimatic.tryCatch,$(document).on("pagecreate","#database-page",t(function(i){var n,r,o;n=function(){function i(){this.fixProblem=e(this.fixProblem,this),this.updateDeviceAttribute=e(this.updateDeviceAttribute,this),this.deleteDeviceAttribute=e(this.deleteDeviceAttribute,this),this.hasPermission=pimatic.hasPermission,this.updateFromJs({problems:[],deviceAttributes:[]}),this.updateListView=ko.computed(function(t){return function(){return t.problems(),pimatic.try(function(){return $("#log-messages").listview("refresh")})}}(this))}return i.mapping={$default:"ignore",problems:{$key:"id",$itemOptions:{$handler:"copy"}},deviceAttributes:{$key:"id",$itemOptions:{$default:"copy",count:"observe",interval:"observe",expire:"observe"}}},i.prototype.updateFromJs=function(t){return ko.mapper.fromJS(t,i.mapping,this)},i.prototype.deleteDeviceAttribute=function(e){return pimatic.client.rest.deleteDeviceAttribute({id:e.id}).done(t(function(t){return function(i){i.success&&t.problems.remove(function(t){return t.id===e.id})}}(this))).fail(ajaxAlertFail)},i.prototype.updateDeviceAttribute=function(e){return pimatic.client.rest.updateDeviceAttribute({id:e.id}).done(t(function(t){return function(i){i.success&&t.problems.remove(function(t){return t.id===e.id})}}(this))).fail(ajaxAlertFail)},i.prototype.fixProblem=function(t){switch(t.action){case"delete":return this.deleteDeviceAttribute(t);case"update":return this.updateDeviceAttribute(t)}},i.prototype.checkDatabase=function(){var e;return e=function(e){return function(){if(null==e.loadProblemsAjax)return pimatic.loading("databasecheck","show",{text:__("Checking Database")}),pimatic.client.rest.checkDatabase({},{timeout:6e4,global:!1}).always(function(){return pimatic.loading("databasecheck","hide")}).done(t(function(t){e.loadProblemsAjax=null,t.success&&e.updateFromJs({problems:t.problems})})).fail(ajaxAlertFail)}}(this),null==this.loadProblemsAjax?e():this.loadProblemsAjax.done(function(){return e()})},i.prototype.querydeviceAttributeInfo=function(){var e;return e=function(e){return function(){if(null==e.loadDAInfoAjax)return pimatic.loading("deviceattributeinfo","show",{text:__("Querying attribute info")}),pimatic.client.rest.queryDeviceAttributeEventsInfo({},{timeout:6e4,global:!1}).always(function(){return pimatic.loading("deviceattributeinfo","hide")}).done(t(function(t){var i,n,r;if(e.loadDAInfoAjax=null,t.success){for(i=0,n=(r=t.deviceAttributes).length;i<n;i++)r[i].count="?";e.updateFromJs({deviceAttributes:t.deviceAttributes}),e.querydeviceAttributeCounts()}})).fail(ajaxAlertFail)}}(this),null==this.loadDAInfoAjax?e():this.loadDAInfoAjax.done(function(){return e()})},i.prototype.querydeviceAttributeCounts=function(){var e;return e=function(e){return function(){if(null==e.loadCountsAjax)return pimatic.loading("deviceattributeCounts","show",{text:__("Querying counts")}),pimatic.client.rest.queryDeviceAttributeEventsCounts({},{timeout:6e4,global:!1}).always(function(){return pimatic.loading("deviceattributeCounts","hide")}).done(t(function(t){var i,n,r,o,a,u,c,s,l,d,p;if(e.loadCountsAjax=null,t.success){for(r=0,u=(l=t.counts).length;r<u;r++)for(i=l[r],o=0,c=(d=e.deviceAttributes()).length;o<c;o++)(n=d[o]).id===i.deviceAttributeId&&n.count(i.count);for(a=0,s=(p=e.deviceAttributes()).length;a<s;a++)"?"===(n=p[a]).count()&&n.count(0)}})).fail(ajaxAlertFail)}}(this),null==this.loadCountsAjax?e():this.loadCountsAjax.done(function(){return e()})},i}();try{pimatic.pages.database=r=new n,ko.applyBindings(r,$("#database-page")[0])}catch(t){o=t,TraceKit.report(o)}})),$(document).on("pagebeforeshow","#database-page",t(function(t){var e,i;try{return(e=pimatic.pages.database).checkDatabase(),e.querydeviceAttributeInfo()}catch(t){return i=t,TraceKit.report(i)}}))}).call(this);