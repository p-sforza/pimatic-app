(function(){var e,i=function(e,i){return function(){return e.apply(i,arguments)}};e=pimatic.tryCatch,$(document).on("pagebeforecreate","#devices-page",e(function(t){var o;return o=function(){function t(){this.discoverDevices=i(this.discoverDevices,this),this.saveCollapseState=i(this.saveCollapseState,this),this.isGroupCollapsed=i(this.isGroupCollapsed,this),this.toggleGroup=i(this.toggleGroup,this),this.onDiscoveredDeviceClicked=i(this.onDiscoveredDeviceClicked,this),this.onEditDeviceClicked=i(this.onEditDeviceClicked,this),this.onDevicesSorted=i(this.onDevicesSorted,this);var t;this.devices=pimatic.devices,this.groups=pimatic.groups,this.hasPermission=pimatic.hasPermission,t=pimatic.storage.get("pimatic.devices")||{},this.collapsedGroups=ko.observable(t.collapsed||{}),this.devicesListViewRefresh=ko.computed(e(function(e){return function(){var i,t,o;for(e.collapsedGroups(),e.devices(),e.isSortingDevices(),e.enabledEditing(),e.discoveredDevices(),i=0,t=(o=e.groups()).length;i<t;i++)o[i].devices();return pimatic.try(function(){return $("#devices").listview("refresh")})}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),this.lockButton=ko.computed(e(function(e){return function(){var i;return i=e.enabledEditing(),{icon:i?"check":"gear"}}}(this))),this.getUngroupedDevices=ko.computed(e(function(e){return function(){var i,t,o,r,s,n,c,a,d,p;for(p=[],o=[],r=0,n=(a=e.groups()).length;r<n;r++)t=a[r],o=o.concat(t.devices());for(s=0,c=(d=e.devices()).length;s<c;s++)i=d[s],-1===ko.utils.arrayIndexOf(o,i.id)&&p.push(i);return p}}(this)))}return t.prototype.enabledEditing=ko.observable(!0),t.prototype.isSortingDevices=ko.observable(!1),t.prototype.discoverMessages=ko.observableArray([]),t.prototype.discoveredDevices=ko.observableArray([]),t.prototype.afterRenderDevice=function(e,i){var t;return t=$("#sortable-handle-template").text(),$(e).find("a").before($(t))},t.prototype.toggleEditing=function(){return this.enabledEditing(!this.enabledEditing())},t.prototype.onDevicesSorted=function(e,i,t){var o,r,s,n,c,a,d;if(o=function(i,t){var o,r;return-1===(r=null==t?0:ko.utils.arrayIndexOf(i.devices(),t.id)+1)&&(r=0),o=i.id,pimatic.client.rest.addDeviceToGroup({deviceId:e.id,groupId:o,position:r}).done(ajaxShowToast).fail(ajaxAlertFail)},c=function(i){var t;return t=i.id,pimatic.client.rest.removeDeviceFromGroup({deviceId:e.id,groupId:t}).done(ajaxShowToast).fail(ajaxAlertFail)},a=function(i){return function(t){var o,r,s,n,c;for(o=[],null==t&&o.push(e.id),r=0,s=(c=i.devices()).length;r<s;r++)(n=c[r])!==e&&(o.push(n.id),null!=t&&n===t&&o.push(e.id));return pimatic.client.rest.updateDeviceOrder({deviceOrder:o}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this),d=function(i,t){var o,r,s,n,c;for(r=[],null==t&&r.push(e.id),s=0,n=(c=i.devices()).length;s<n;s++)(o=c[s])!==e.id&&(r.push(o),null!=t&&o===t.id&&r.push(e.id));return pimatic.client.rest.updateGroup({groupId:i.id,group:{devicesOrder:r}}).done(ajaxShowToast).fail(ajaxAlertFail)},null!=i)return s=i instanceof pimatic.Device?i.group():i instanceof pimatic.Group?i:null,r=i instanceof pimatic.Device?i:void 0,n=e.group(),s!==n?null!=s?o(s,r):null!=n?c(n):a(r):null!=s?d(s,r):a(r)},t.prototype.onDropDeviceOnTrash=function(e){if(confirm(__("Do you really want to delete the %s device?",e.name())))return function(){return pimatic.loading("deletedevice","show",{text:__("Saving")}),pimatic.client.rest.removeDevice({deviceId:e.id}).always(function(){return pimatic.loading("deletedevice","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)}()},t.prototype.onAddDeviceClicked=function(){return this.hasPermission("devices","write")?(jQuery.mobile.pageParams={action:"add"},!0):(pimatic.showToast(__("Sorry, you have no permissions to edit this device.")),!1)},t.prototype.onEditDeviceClicked=function(e){return this.hasPermission("devices","write")?(jQuery.mobile.pageParams={action:"update",device:e},!0):(pimatic.showToast(__("Sorry, you have no permissions to edit this device.")),!1)},t.prototype.onDiscoveredDeviceClicked=function(e){return this.hasPermission("devices","write")?(jQuery.mobile.pageParams={action:"discovered",discoveredDevice:e},!0):(pimatic.showToast(__("Sorry, you have no permissions to edit this device.")),!1)},t.prototype.toggleGroup=function(e){var i;return(i=this.collapsedGroups())[e.id]?delete i[e.id]:i[e.id]=!0,this.collapsedGroups(i),this.saveCollapseState(),!1},t.prototype.isGroupCollapsed=function(e){return!0===this.collapsedGroups()[e.id]},t.prototype.saveCollapseState=function(){var e;return e=pimatic.storage.get("pimatic.devices")||{},e.collapsed=this.collapsedGroups(),pimatic.storage.set("pimatic.devices",e)},t.prototype.discoverDevices=function(){return 2e4,this.discoverMessages([]),this.discoveredDevices([]),pimatic.client.rest.discoverDevices({time:2e4}).done(function(e){return function(){return pimatic.loading("discoverdevices","show",{text:__("Searching for devices")}),setTimeout(function(){return e.discoverMessages([]),pimatic.loading("discoverdevices","hide")},2e4)}}(this)).fail(ajaxAlertFail)},t}(),pimatic.pages.devices=new o})),$(document).on("pagecreate","#devices-page",e(function(e){var i,t,o;i=pimatic.pages.devices;try{ko.applyBindings(i,$("#devices-page")[0])}catch(e){t=e,TraceKit.report(t),null!=(o=pimatic.storage)&&o.removeAll(),window.location.reload()}$("#devices .handle").disableSelection(),pimatic.socket.on("discoverMessage",function(e){return i.discoverMessages.push(e)}),pimatic.socket.on("deviceDiscovered",function(e){return i.discoveredDevices.push(e)})})),$(document).on("pagebeforeshow","#devices-page",e(function(e){return pimatic.try(function(){return $("#devices").listview("refresh")})}))}).call(this);