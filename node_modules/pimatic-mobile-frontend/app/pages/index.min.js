(function(){var lastCarouselWidth,tc,updateCarousel,bind=function(e,t){return function(){return e.apply(t,arguments)}},indexOf=[].indexOf||function(e){for(var t=0,i=this.length;t<i;t++)if(t in this&&this[t]===e)return t;return-1};tc=pimatic.tryCatch,$(document).on("pagecreate","#index",tc(function(event){var IndexViewModel,e,error,indexPage,ref;IndexViewModel=function(){function e(){this.isGroupCollapsed=bind(this.isGroupCollapsed,this),this.createToggleGroupCallback=bind(this.createToggleGroupCallback,this),this.onDropItemOnTrash=bind(this.onDropItemOnTrash,this),this.onItemsSorted=bind(this.onItemsSorted,this),this.toggleEditing=bind(this.toggleEditing,this),this.onLogoutClicked=bind(this.onLogoutClicked,this),this.onLogMessageClicked=bind(this.onLogMessageClicked,this),this.onAddItemClicked=bind(this.onAddItemClicked,this),this.showDevicePage=bind(this.showDevicePage,this),this.getItemTemplate=bind(this.getItemTemplate,this);var t,i,n,o,a,r,s,c,d,l,u,p;if(this.groups=pimatic.groups,this.hasPermission=pimatic.hasPermission,this.updateFromJs({ruleItemCssClass:"",hasRootCACert:!1,collapsedGroups:{}}),this.lockButton=ko.computed(tc(function(e){return function(){var t;return t=e.enabledEditing(),{icon:t?"check":"gear"}}}(this))),this.logoutText=ko.computed(tc(function(){return"string"==typeof pimatic.username()?__("Logout")+" ("+pimatic.username()+")":__("Logout")})),s=null,r=null,o=null,a={offset:40,tolerance:10,classes:{initial:"animated",pinned:"slideDown",unpinned:"slideUp"}},d=null,c=null,p=null,u=function(e){return function(t){var i,n,o;if(null==t&&(t=!0),null!=s&&null!=r)return n=null!=e.activeDevicepage()?e.devicepages.indexOf(e.activeDevicepage()):0,(o=$(r.find(".items")[n]).width())!==d&&s.css({width:o}),(i=s.height())!==c&&r.find(".items").each(function(){return $(this).parent().css("padding-top",i)}),clearTimeout(p),t&&(p=setTimeout(function(){return u(!1)},350)),d=o,c=i}}(this),this.devicepagesTabsRefresh=ko.computed(tc(function(e){return function(){var t,i,n,r,c,d;if(e.bindingsApplied())return t=e.devicepages(),i=e.enabledEditing(),s=$("#item-tabs"),null!=o&&o.destroy(),pimatic.try(function(){return s.navbar("destroy")}),ko.cleanNode(s[0]),r=t.length>0&&e.hasPermission("pages","read")?"<ul data-bind=\"foreach: devicepages\">\n  <li class=\"page-tab\">\n    <a \n      data-ajax='false' \n      data-bind=\"\n        attr: {\n          href: '#item-tab-'+$data.id\n        }, \n        text: name, \n        css: {'ui-btn-active': $data == $root.activeDevicepage()}\n      \"\n    ></a>\n  </li>\n</ul>":"<ul></ul>",s.html(r),ko.applyBindings(e,s[0]),i&&s.find("ul").append($("#edit-devicepage-link-template").text()),(t.length>0||e.enabledEditing())&&e.hasPermission("pages","read")&&(s.navbar(),s.find("ul").removeClass("ui-grid-a ui-grid-duo"),(d=s.find("li")).length<=6?(c=100/d.length+"%",n=d.length):(n=Math.ceil(d.length/2),c=100/n+"%"),d.each(function(e){var t;if($(this).css({width:c,clear:"none"}).removeClass("ui-block-a ui-block-b ui-block-c ui-block-d ui-block-e").addClass("ui-block-a"),t=$(this).find("a"),e+1>n)return t.css("border-top-width",0)}),(o=new Headroom(s[0],a)).init()),u()}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),l=function(e){return function(){var t;if(null!=o&&null!=e.activeDevicepage())return o.destroy(),t=e.devicepages.indexOf(e.activeDevicepage()),a.scroller=r.find(".owl-wrapper .owl-item")[t],(o=new Headroom(s[0],a)).init()}}(this),t=[],ko.computed(tc(function(e){return function(){var i,n,o,a,s,c,d,p;if(e.bindingsApplied()){for(n=e.devicepages(),o=ko.utils.compareArrays(n,t),t=function(){var e,t,i;for(i=[],e=0,t=n.length;e<t;e++)p=n[e],i.push(p);return i}(),i=!1,s=0,c=o.length;s<c;s++)if("retained"!==o[s].status){i=!0;break}i&&(r=$("#item-lists"),ko.cleanNode(r[0]),null!=(d=r.data("owlCarousel"))&&d.destroy(),n.length>0&&e.hasPermission("pages","read")?(a=$("#devicepages-template").text(),r.html(a),null!=ko.dataFor($("#index")[0])&&ko.applyBindings(e,r[0]),r.find('[data-role="listview"]').listview(),r.owlCarousel({slideSpeed:300,paginationSpeed:400,singleItem:!0,pagination:!1,navigation:!1,lazyEffect:!1,lazyLoad:!1,afterAction:function(){},afterMove:function(t){var i;return i=t.data("owlCarousel").currentItem,e.activeDevicepage(e.devicepages()[i])},afterUpdate:function(){return u()}}),r.width(),l()):r.html(""),u())}}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),this.activeDevicepage.subscribe(function(e){return function(t){var i,n;if(null!=t&&null!=(n=$("#item-lists").data("owlCarousel"))&&-1!==(i=e.devicepages.indexOf(t)))return n.goTo(i),l(),u()}}(this)),ko.computed(function(e){return function(){var t,i;return 0===(t=e.devicepages()).length?e.activeDevicepage(null):null==e.activeDevicepage()?e.activeDevicepage(t[0]):(i=e.activeDevicepage(),indexOf.call(t,i)>=0?void 0:e.activeDevicepage(t[0]))}}(this)),this.itemsListViewRefresh=ko.computed(tc(function(e){return function(){var t,i,n,o,a,r;for(t=0,n=(a=e.devicepages()).length;t<n;t++)a[t].devices();for(i=0,o=(r=pimatic.groups()).length;i<o;i++)r[i].devices();return e.isSortingItems(),e.enabledEditing(),e.collapsedGroups(),pimatic.try(function(){return $('#item-lists [data-role="listview"]').each(function(){var e;return null==(e=$(this)).data("mobileListview")?e.listview():e.listview("refresh")})})}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),this.deviepagesRefresh=ko.computed(tc(function(e){return function(){return e.devicepages(),pimatic.try(function(){return $(".nav-panel-menu").listview("refresh")})}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),pimatic.storage.isSet("pimatic.indexPage")){i=pimatic.storage.get("pimatic.indexPage");try{this.updateFromJs(i)}catch(e){n=e,TraceKit.report(n),pimatic.storage.removeAll(),window.location.reload()}}this.autosave=ko.computed(function(t){return function(){return i=ko.mapper.toJS(t,e.mapping),pimatic.storage.set("pimatic.indexPage",i)}}(this)).extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}}),this.toggleEditingText=ko.computed(tc(function(e){return function(){return e.enabledEditing()?__("Lock lists"):__("Edit lists")}}(this)))}return e.mapping={$default:"ignore",ruleItemCssClass:"observe",hasRootCACert:"observe",collapsedGroups:"observe"},e.prototype.devicepages=pimatic.devicepages,e.prototype.errorCount=pimatic.errorCount,e.prototype.activeDevicepage=ko.observable(null),e.prototype.isSortingItems=ko.observable(!1),e.prototype.enabledEditing=ko.observable(!1),e.prototype.bindingsApplied=ko.observable(!1),e.prototype.getItemTemplate=function(e){return e.getItemTemplate()+"-template"},e.prototype.showDevicePage=function(e){return this.activeDevicepage(e),$("#nav-panel").panel("close"),!0},e.prototype.updateFromJs=function(t){return ko.mapper.fromJS(t,e.mapping,this)},e.prototype.onAddItemClicked=function(){return!0},e.prototype.onLogMessageClicked=function(){return jQuery.mobile.pageParams={selectErrors:!0},!0},e.prototype.onLogoutClicked=function(){return $.ajax({type:"GET",url:"/logout"}).fail(function(e,t,i){return"Unauthorized"===t||"Unauthorized"===i?setTimeout(function(){return pimatic.storage.removeAll(),pimatic.showToast(e.responseText),window.location.reload()},100):ajaxAlertFail(e,t,i)}),!1},e.prototype.toggleEditing=function(){return this.enabledEditing(!this.enabledEditing())},e.prototype.onItemsSorted=function(e,t,i){var n,o,a,r,s,c;if(n=function(t,i){var n,o;return-1===(o=null==i?0:ko.utils.arrayIndexOf(t.devices(),i.device.id)+1)&&(o=0),n=t.id,pimatic.client.rest.addDeviceToGroup({deviceId:e.device.id,groupId:n,position:o}).done(ajaxShowToast).fail(ajaxAlertFail)},s=function(t){var i;return i=t.id,pimatic.client.rest.removeDeviceFromGroup({deviceId:e.device.id,groupId:i}).done(ajaxShowToast).fail(ajaxAlertFail)},c=function(t){return function(i){var n,o,a,r,s;for(n=[],null==i&&n.push(e.device.id),a=0,r=(s=t.activeDevicepage().devices()).length;a<r;a++)(o=s[a])!==e&&(n.push(o.device.id),null!=i&&o===i&&n.push(e.device.id));return pimatic.client.rest.updatePage({pageId:t.activeDevicepage().id,page:{devicesOrder:n}}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this),null!=t)return o=t instanceof pimatic.DeviceItem?t.device.group():t instanceof pimatic.Group?t:null,r=t instanceof pimatic.DeviceItem?t:void 0,a=e.device.group(),o!==a?null!=o?(n(o,r),c(r)):null!=a?(s(a),c(r)):c(r):c(r)},e.prototype.onDropItemOnTrash=function(e){if(confirm(__("Do you really want to delete the item?")))return function(t){return function(){var i;return i=t.activeDevicepage(),pimatic.loading("deleteitem","show",{text:__("Saving")}),pimatic.client.rest.removeDeviceFromPage({deviceId:e.deviceId,pageId:i.id}).always(function(){return pimatic.loading("deleteitem","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this)()},e.prototype.createToggleGroupCallback=function(e,t){var i;return i=e.id+"$"+t.id,function(e){return function(){var t;return(t=e.collapsedGroups())[i]?delete t[i]:t[i]=!0,e.collapsedGroups(t),!1}}(this)},e.prototype.isGroupCollapsed=function(e,t){var i;return i=e.id+"$"+t.id,!0===this.collapsedGroups()[i]},e}(),pimatic.pages.index=indexPage=new IndexViewModel;try{ko.applyBindings(indexPage,$("#index")[0]),indexPage.bindingsApplied(!0)}catch(error){e=error,TraceKit.report(e),null!=(ref=pimatic.storage)&&ref.removeAll(),window.location.reload()}$("#index").on("vclick",".page-tab",tc(function(e){var t;return t=ko.dataFor(this),indexPage.activeDevicepage(t),!1})),$("#index").on("change","#item-lists .switch",tc(function(e){ko.dataFor(this).onSwitchChange()})),$("#index").on("slidestop"," #item-lists .dimmer",tc(function(e){ko.dataFor(this).onSliderStop()})),$("#index").on("vclick","#item-lists .shutter-down",tc(function(e){return ko.dataFor(this).onShutterDownClicked(),!1})),$("#index").on("vclick","#item-lists .shutter-up",tc(function(e){return ko.dataFor(this).onShutterUpClicked(),!1})),$("#index").on("vclick","#item-tabs #add-devicepage-link",tc(function(e){return indexPage.onAddPageClicked(),!0})),$("#items .handle").disableSelection(),$("#nav-panel").on("panelopen panelclose",tc(function(e){if($("#item-lists").is(":visible"))return updateCarousel()})),$(document).on("vclick","#to-graph-page",function(){var e,t;return t=$("#to-graph-page").attr("data-deviceId"),e=pimatic.getDeviceById(t),jQuery.mobile.pageParams={device:e},jQuery.mobile.changePage("#graph-page",{transition:"slide"})}),$(document).on("vclick","#to-device-editor-page",function(){var e,t;return t=$("#to-device-editor-page").attr("data-deviceId"),e=pimatic.getDeviceById(t),jQuery.mobile.pageParams={action:"update",device:e,back:"#index"},jQuery.mobile.changePage("#edit-device-page",{transition:"slide"})}),$(document).on("vclick","#to-device-xButton",function(){var device,deviceId;return deviceId=$("#to-device-xButton").attr("data-deviceId"),(device=pimatic.getDeviceById(deviceId)).rest.xButton({}).done(function(_this){return function(response){if(response.success)return eval(response.result);throw new Error("xButton call failed: "+response.result+"!")}}(this)).fail(ajaxAlertFail)})})),lastCarouselWidth=0,updateCarousel=function(){return pimatic.try(function(){var e,t;return e=$("#item-lists"),(t=e.width())!==lastCarouselWidth&&e.data("owlCarousel").updateVars(),lastCarouselWidth=t})},$(document).on("click",".content-overlay",tc(function(e){return $("#nav-panel").panel("close")})),$(document).on("pageshow","#index",tc(function(e){return updateCarousel(),setTimeout(function(){return updateCarousel(),$.mobile.resetActivePageHeight()},1)})),$(document).on("pagebeforeshow","#index",tc(function(e){return setTimeout(function(){return pimatic.try(function(){return $("#nav-panel").find('[data-role="listview"]').listview("refresh")}),pimatic.try(function(){return $("#item-lists").find('[data-role="listview"]').listview("refresh")}),pimatic.try(function(){return $("#item-tabs").navbar()})},2)}))}).call(this);