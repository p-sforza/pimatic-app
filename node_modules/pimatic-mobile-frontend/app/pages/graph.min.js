(function(){var t,e,r,a=function(t,e){return function(){return t.apply(e,arguments)}},n=[].indexOf||function(t){for(var e=0,r=this.length;e<r;e++)if(e in this&&this[e]===t)return e;return-1};r=pimatic.tryCatch,t=Array.prototype.concat,LazyLoad.js(t.apply(scripts.dygraph,scripts.datepicker)),$(document).on("pagecreate","#graph-page",function(t){var e,i,o;i=function(){function t(){}return t.prototype.query=[],t.prototype.addTask=function(t,e){return null==e&&(e=!1),t.onComplete=function(e){return function(){return t.status="complete",e.next()}}(this),e?this.query.unshift(t):this.query.push(t),this.start()},t.prototype.start=function(){var t;if(0!==this.query.length&&"running"!==(t=this.query[0]).status)return t.status="running",t.start()},t.prototype.next=function(){var t;return this.query=function(){var e,r,a,n;for(n=[],e=0,r=(a=this.query).length;e<r;e++)"complete"!==(t=a[e]).status&&n.push(t);return n}.call(this),this.start()},t.prototype.clear=function(){var t,e,r,a;for(t=0,e=(r=this.query).length;t<e;t++)null!=(a=r[t]).abort&&a.abort(),a.status="aborted";return this.query.length=0},t}(),e=function(){function t(){this.afterRenderAttribute=a(this.afterRenderAttribute,this);var t;ko.computed(r(function(t){return function(){var e,r,a;if(!t.pageCreated())return!1;for(e=0,r=(a=pimatic.groups()).length;e<r;e++)a[e].devices();return pimatic.try(function(){return $("#graph-device-list").listview("refresh")})}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),this.averageDurationText=ko.computed(r(function(t){return function(){return __("Average values of %s.",t.averageDuration())}}(this))),this.chosenDate($.datepicker.formatDate(this.dateFormat,new Date)),t=function(t){return"boolean"===t.type?"__state":t.unit},ko.computed(r(function(e){return function(){var r,a,i,o,u,s,l,c,p,h,d,g,f,b,m,v,y,D,k,w,x,A,T,F,L,C,S,R,_,q,B,P,M,O,Q,W,I,N,E,j,z,G,V,H;if(0===(c=e.displayedAttributes()).length)return null!=e.chart&&(e.chart.destroy(),e.chart=null),$("#chart").hide(),$("#chart-info").hide(),void $("#chart-no-data").hide();if(_=0,Q=[],R=c.filter(function(t){return"number"===t.attribute.type}),R=R.concat(c.filter(function(t){return"boolean"===t.attribute.type})),c=R,e.dataLoadingQuery.clear(),B=e.chosenRange(),l=e.chosenDate(),null!=$.datepicker.parseDate(e.dateFormat,l)){for(d=e.getGroupByTimeForRange(B),e.averageDuration(e.timeDurationToText(d)),j=[],z=[],v=0,k=c.length;v<k;v++)(m=c[v]).added=!1,m.range===B&&m.chosenDate===l||(m.range=null,m.data=null),E=t(m.attribute),"boolean"===m.attribute.type&&(Q[_]=m.attribute,m.stateOffset=_,_++),n.call(j,E)<0&&(j.push(E),z[E]=m.attribute);for(H=[],O=function(t){var e,r;return r=Math.floor(t),e=Q[r],t=t!==r,e.formatValue(t)},I=[],u=y=0,w=Q.length;y<w;u=++y)i=Q[u],I.push({v:u,label:i.labels[1]}),I.push({v:u+.5,label:i.labels[0]});for(W=function(){return I},p=function(t){var e,r,a;return a=z[t],"__state"===t?(e=O,r=W):(e=function(t){return a.formatValue(t)},r=Dygraph.numericTicks),H.push({axisLabelFormatter:e,valueFormatter:e,ticker:r})},D=0,x=j.length;D<x;D++)p(j[D]);for(P=e.getDateRange(),N=P.to,h=P.from,o=function(t){return 0===t?"y":"y"+(t+1)},s={labelsDiv:$("#chart-legend")[0],legend:"always",tooltip:"follow",staticLegend:!0,strokeWidth:2,pointSize:3,width:null,height:null,labels:["Date"],showRangeSelector:!0,connectSeparatedPoints:!0,rangeSelectorPlotStrokeColor:e.colors[0],rangeSelectorPlotFillColor:"#e0e6ec",xAxisHeight:35,highlightSeriesBackgroundAlpha:.9,highlightSeriesOpts:{},gridLineColor:"#BDBDBD",series:{},axes:{x:{valueFormatter:function(t){var e;return(e=pimatic.timestampToDateTime(t)).date+" "+e.time},pixelsPerLabel:25,axisTickSize:10}}},g=S=0,A=H.length;S<A;g=++S)V=H[g],s.axes[o(g)]=V;for(a=[],b=!1,G=function(){var t,r,n;return t=$("#chart"),r=$("#chart-no-data"),a.length>0?(r.hide(),b?(n={file:a},null!=s.axes.x.dateWindow&&(n.axes=s.axes),e.chart.updateOptions(n)):(null!=e.chart&&e.chart.destroy(),t.show().css("width","100%"),t.parent().css("padding-right",null!=s.axes.y2?0:"20px"),$("#chart-info").show(),e.chart=new Dygraph(t[0],a,s),b=!0)):r.show()},500,e.addChartData=function(t,r,n){var i,o,u,l,p,h,d,f,b,m,v;if(i=a,h=[],null!=(v=null!=(f=e.chart)?f.xAxisRange():void 0)&&a.length>0&&(l=v[1]===a[a.length-1][0].getTime()),"boolean"===r.attribute.type)for(d=0,p=n.length;d<p;d++)(u=n[d])[1]=u[1]?r.stateOffset+.5:r.stateOffset;if(0===n.length)h=a;else{for(m=n[0][0],o=0,b=0;b<n.length;){for(;o<i.length&&i[o][0].getTime()<m-500;)h.push(i[o]),o++;if(o<i.length&&b<n.length&&Math.abs(n[b][0]-i[o][0].getTime())<=500)i[o][t+1]=n[b][1],h.push(i[o]),o++,++b<n.length&&(m=n[b][0]);else{for((u=new Array(c.length+1))[0]=new Date(n[b][0]),g=1;g<c.length+1;)u[g]=null,g++;u[t+1]=n[b][1],h.push(u),++b<n.length&&(m=n[b][0])}}for(;o<i.length;)h.push(i[o]),o++}return a=h,null!=v&&l&&(v[1]=a[a.length-1][0].getTime(),s.axes.x.dateWindow=v),G()},C=function(t,r,a,n){var i;return"function"!=typeof n&&(n=function(){}),i={attributeName:t.attribute.name,abort:n},i.start=function(){return pimatic.client.rest.querySingleDeviceAttributeEvents({deviceId:t.device.id,attributeName:t.attribute.name,criteria:{before:r,limit:1,order:"time",orderDirection:"desc"}},{global:!1}).done(function(t){if("aborted"!==i.status)return t.success?a(t.events):void 0}).always(function(){if("aborted"!==i.status)return i.onComplete()}).fail(function(){return n()})},e.dataLoadingQuery.addTask(i,!1)},F=100,L=function(t,r,a,n,i,o){var u;return null==o&&(o=!1),"function"!=typeof i&&(i=function(){}),u={attributeName:t.attribute.name,abort:i},u.start=function(){var e;return e=(new Date).getTime(),pimatic.client.rest.querySingleDeviceAttributeEvents({deviceId:t.device.id,attributeName:t.attribute.name,criteria:{after:r,before:a,limit:F,groupByTime:"number"!==t.attribute.type||t.attribute.discrete?void 0:d}},{global:!1}).done(function(r){var o,s,l,c;if("aborted"!==u.status&&r.success){if(o=r.events.length,s=o===F,!(o>0))return n(r.events,!1);if(c=(new Date).getTime()-e,c=Math.max(c,1),F=Math.floor(o*(3e3/c)),F=Math.max(F,100),n(r.events,s),s)return l=r.events[o-1],L(t,l.time+1,a,n,i,!0)}}).always(function(){if("aborted"!==u.status)return u.onComplete()}).fail(function(){return i()})},e.dataLoadingQuery.addTask(u,o)},r=function(r,a){var i,u,c,p,d,g,f,b,m;for(m=ko.utils.arrayIndexOf(j,t(a.attribute)),f=d=a.device.name()+": "+a.attribute.label,g=2;n.call(s.labels,d)>=0;)d=f+" "+g,g++;return b={axis:o(m),stepPlot:a.attribute.discrete,color:e.colors[r%e.colors.length],showInRangeSelector:0===r},"boolean"===a.attribute.type&&(b.strokePattern=Dygraph.DASHED_LINE),a.added=!0,a.chosenDate=l,a.range=B,a.index=r,a.serie(b),s.labels.push(d),s.series[d]=b,G(),i=[],p="loading-series-"+a.device.id+"_"+a.attribute.name,pimatic.loading(p,"show",{text:__("Loading data for "+a.device.name()+": "+a.attribute.label),blocking:!1}),c=function(t){var n,o,u;return n=function(){var e,r,a,n;for(n=[],r=0,e=t.length;r<e;r++)a=t[r],o=a.time,u=a.value,n.push([o,u]);return n}(),e.addChartData(r,a,n),i=i.concat(n)},u=function(){return L(a,h.getTime(),N.getTime(),function(t,e){c(t),e||(a.data=i,a.range=B,pimatic.loading(p,"hide"))},function(){return pimatic.loading(p,"hide")})},a.attribute.discrete?C(a,h.getTime(),function(t){return 1===t.length&&(t[0].time=h.getTime()),c(t),u()}):u()},M=[],f=q=0,T=c.length;q<T;f=++q)m=c[f],M.push(r(f,m));return M}}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}})}return t.prototype.groups=pimatic.groups,t.prototype.displayedAttributes=ko.observableArray(),t.prototype.dateFrom=ko.observable(),t.prototype.dateTo=ko.observable(),t.prototype.chosenRange=ko.observable("day"),t.prototype.chosenDate=ko.observable(),t.prototype.pageCreated=ko.observable(!1),t.prototype.dataLoadingQuery=new i,t.prototype.averageDuration=ko.observable(null),t.prototype.dateFormat="yy-mm-dd",t.prototype.colors=["#7cb5ec","#434348","#90ed7d","#f7a35c","#8085e9","#f15c80","#e4d354","#8085e8","#8d4653","#91e8e1"],t.prototype.getUngroupedDevicesWithGraphableAttribute=function(){var t,e;return e=pimatic.getUngroupedDevices(),function(){var r,a,n;for(n=[],r=0,a=e.length;r<a;r++)(t=e[r]).hasAttibuteWith(function(t){var e;return"boolean"===(e=t.type)||"number"===e})&&n.push(t);return n}.call(this)},t.prototype.afterRenderAttribute=function(t){var e;return e=$(t).find("select"),pimatic.try(function(){return e.flipswitch()})},t.prototype.getDisplayedAttribute=function(t,e){var r,a,n,i;for(a=0,n=(i=this.displayedAttributes()).length;a<n;a++)if((r=i[a]).device===t&&r.attribute===e)return r;return null},t.prototype.addToDisplayedAttributes=function(t,e){if(null==this.getDisplayedAttribute(t,e))return this.displayedAttributes.push({device:t,attribute:e,serie:ko.observable()})},t.prototype.removeFromDisplayedAttributes=function(t,e){return this.displayedAttributes.remove(function(r){return r.device===t&&r.attribute===e})},t.prototype.isLive=function(){var t,e;return e=new Date,null!==(t=$.datepicker.parseDate(this.dateFormat,this.chosenDate()))&&(t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate())},t.prototype.getDateRange=function(){var t,e,r,a;switch(r=this.chosenRange(),t=$.datepicker.parseDate(this.dateFormat,this.chosenDate()),this.isLive()?a=new Date:(a=new Date(t)).setDate(a.getDate()+1),e=new Date(a),r){case"day":e.setDate(a.getDate()-1);break;case"week":e.setDate(a.getDate()-7);break;case"month":e.setDate(a.getDate()-30);break;case"year":e.setDate(a.getDate()-365)}return{from:e,to:a}},t.prototype.getGroupByTimeForRange=function(t){return function(){switch(t){case"day":return 3e5;case"week":return 18e5;case"month":return 72e5;case"year":return 144e5}}()},t.prototype.timeDurationToText=function(t){var e,r,a,n;return t/=1e3,n="",r=t/60,0!==(a=t%60)&&(n=a+"s "+n),0!==r&&(r<60?0!==r&&(n=r+"min "+n):(e=r/60,n=0!==(r%=60)?e+"h "+r+"min "+n:e+"h "+n)),n.trim()},t}(),pimatic.pages.graph=o=new e,ko.applyBindings(o,$("#graph-page")[0]),o.pageCreated(!0),$("#graph-page").on("click",".device-attribute-list .show-button",r(function(t){var e,r;e=ko.dataFor(this),r=ko.dataFor($(this).parents(".graph-device")[0]),o.addToDisplayedAttributes(r,e)})),$("#graph-page").on("click",".device-attribute-list .hide-button",r(function(t){var e,r;e=ko.dataFor(this),r=ko.dataFor($(this).parents(".graph-device")[0]),o.removeFromDisplayedAttributes(r,e)}))}),$(document).on("pagebeforeshow","#graph-page",function(t){var e,r,a,n,i,o,u,s,l;if(i=pimatic.pages.graph,r=null!=(o=jQuery.mobile.pageParams)?o.device:void 0,jQuery.mobile.pageParams={},null!=r){for(l=[],a=0,n=(u=r.attributes()).length;a<n;a++)"number"!==(s=(e=u[a]).type)&&"boolean"!==s||l.push({device:r,attribute:e,serie:ko.observable()});i.displayedAttributes(l)}}),e=null,$(document).on("pagehide","#graph-page",function(t){pimatic.pages.graph.dataLoadingQuery.clear(),null!=e&&pimatic.socket.removeListener("deviceAttributeChanged",e)}),$(document).on("pagebeforeshow","#graph-page",function(){var t;return t=pimatic.pages.graph,pimatic.socket.on("deviceAttributeChanged",e=function(e){var r,a,n,i;if(t.isLive())for(a=0,n=(i=t.displayedAttributes()).length;a<n;a++)(r=i[a]).device.id===e.deviceId&&r.attribute.name===e.attributeName&&null!=r.serie&&null!=r.data&&r.added&&null!=r.index&&null!=t.addChartData&&(t.addChartData(r.index,r,[[new Date(e.time).getTime(),e.value]]),pimatic.showToast(__("%s: %s value: %s",r.device.name(),r.attribute.label,r.attribute.formatValue(e.value))))})})}).call(this);