(function(){var e,i=[].indexOf||function(e){for(var i=0,t=this.length;i<t;i++)if(i in this&&this[i]===e)return i;return-1};e=Array.prototype.concat,LazyLoad.js(e.apply(scripts.jsonschemaeditor)),$(document).on("pagebeforecreate","#edit-device-page",function(e){var i,t;if(null==pimatic.pages.editDevice){i=function(){function e(){this.pageTitle=ko.computed(function(e){return function(){return"add"===e.action()?__("Add New Device"):__("Edit Device")}}(this)),pimatic.autoFillId(this.deviceName,this.deviceId,this.action),this.deviceClass.subscribe(function(e){return function(i){return null!=i&&"string"==typeof i&&i.length>0?pimatic.client.rest.getDeviceConfigSchema({className:i}).done(function(t){var a,c,n;if(null!=t.success)return a=t.configSchema||{error:__("No plugin was found that handles this device class."),type:"object",properties:{}},delete a.properties.id,delete a.properties.name,delete a.properties.class,n=null,null==e.lastDeviceClass?(c=jsonschemaeditor.unwrap(e.deviceConfig()),n=jsonschemaeditor.wrap(a,c)):n=jsonschemaeditor.wrap(a,{}),e.configSchema(null),e.deviceConfig(n()),jsonschemaeditor.enhanceSchema(a,null),e.configSchema(a),e.lastDeviceClass=i}):e.configSchema(null)}}(this))}return e.prototype.action=ko.observable("add"),e.prototype.deviceName=ko.observable(""),e.prototype.deviceId=ko.observable(""),e.prototype.deviceClass=ko.observable(""),e.prototype.deviceClasses=ko.observableArray(),e.prototype.deviceConfig=ko.observable({}),e.prototype.configSchema=ko.observable(null),e.prototype.back=null,e.prototype.lastDeviceClass=null,e.prototype.editor=null,e.prototype.afterRenderItem=function(e,i){var t;return t=$("#sortable-handle-template").text(),$(e).find("a").before($(t))},e.prototype.resetFields=function(){return this.deviceName(""),this.deviceId(""),this.deviceClass(""),this.configSchema(null),this.deviceConfig({})},e.prototype.onSubmit=function(){var e,i;if(e=jsonschemaeditor.unwrap(this.deviceConfig()),i=[],jsonschemaeditor.validate(this.configSchema(),e,i),!(i.length>0))return e.id=this.deviceId(),e.name=this.deviceName(),e.class=this.deviceClass(),function(){switch(this.action()){case"add":return pimatic.client.rest.addDeviceByConfig({deviceConfig:e});case"update":return pimatic.client.rest.updateDeviceByConfig({deviceConfig:e});default:throw new Error("Illegal devicedevice action: "+action())}}.call(this).done(function(e){return function(i){var t,a;return t=null!=(a=e.back)?a:"#devices-page",i.success?$.mobile.changePage(t,{transition:"slide",reverse:!0}):alert(i.error)}}(this)).fail(ajaxAlertFail),!1;alert(i.join("\n"))},e.prototype.onRemove=function(){return confirm(__("Do you really want to delete the %s device?",this.deviceName()))&&pimatic.client.rest.removeDevice({deviceId:this.deviceId()}).done(function(e){return function(i){var t,a;return t=null!=(a=e.back)?a:"#devices-page",i.success?$.mobile.changePage(t,{transition:"slide",reverse:!0}):alert(i.error)}}(this)).fail(ajaxAlertFail),!1},e.prototype.onCancel=function(){var e,i;return e=null!=(i=this.back)?i:"#devices-page",$.mobile.changePage(e,{transition:"slide",reverse:!0})},e}();try{pimatic.pages.editDevice=new i}catch(e){t=e,TraceKit.report(t)}}}),$(document).on("pagebeforeshow","#edit-device-page",function(e){var i;return i=pimatic.pages.editDevice,i.lastDeviceClass=null,pimatic.client.rest.getDeviceClasses({}).done(function(e){var t,a;if(e.success)return a=[""].concat(e.deviceClasses),null!=(t=i.deviceClass())&&t.length>0&&a.push(t),i.deviceClasses(a)})}),$(document).on("pagecreate","#edit-device-page",function(e){var i;try{return ko.applyBindings(pimatic.pages.editDevice,$("#edit-device-page")[0])}catch(e){return i=e,TraceKit.report(i)}}),$(document).on("pagebeforeshow","#edit-device-page",function(e){var t,a,c,n,o,r;n=pimatic.pages.editDevice,r=jQuery.mobile.pageParams,jQuery.mobile.pageParams={},o=function(e,t,a,c,o){var r,s;return n.action(e),n.deviceId(t),n.deviceName(a),n.deviceClass(null),n.configSchema(null),n.deviceConfig(c),n.back=o,r=pimatic.pages.editDevice.deviceClasses(),s=c.class,i.call(r,s)<0&&(r.push(c.class),n.deviceClasses(r)),n.deviceClass(c.class)},"update"===(null!=r?r.action:void 0)?o("update",(a=r.device).id,a.name(),a.config,null!=r?r.back:void 0):"discovered"===(null!=r?r.action:void 0)?o("add",(t=(c=r.discoveredDevice).config).id||"",t.name||c.deviceName,t):(n.resetFields(),n.action("add"))})}).call(this);