(function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}};e=pimatic.tryCatch,$(document).on("pagebeforecreate","#rules-page",e(function(i){var r;return r=function(){function i(){this.saveCollapseState=t(this.saveCollapseState,this),this.onEditRuleClicked=t(this.onEditRuleClicked,this),this.isGroupCollapsed=t(this.isGroupCollapsed,this),this.toggleGroup=t(this.toggleGroup,this),this.onRulesSorted=t(this.onRulesSorted,this);var i;this.rules=pimatic.rules,this.groups=pimatic.groups,this.hasPermission=pimatic.hasPermission,i=pimatic.storage.get("pimatic.rules")||{},this.collapsedGroups=ko.observable(i.collapsed||{}),this.rulesListViewRefresh=ko.computed(e(function(e){return function(){var t,i,r;for(e.rules(),e.isSortingRules(),e.enabledEditing(),e.collapsedGroups(),t=0,i=(r=e.groups()).length;t<i;t++)r[t].rules();return pimatic.try(function(){return $("#rules").listview("refresh").addClass("dark-background")})}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),this.lockButton=ko.computed(e(function(e){return function(){var t;return t=e.enabledEditing(),{icon:t?"check":"gear"}}}(this))),this.getUngroupedRules=ko.computed(e(function(e){return function(){var t,i,r,o,n,a,u,l,s,p;for(p=[],i=[],r=0,n=(l=e.groups()).length;r<n;r++)t=l[r],i=i.concat(t.rules());for(o=0,a=(s=e.rules()).length;o<a;o++)u=s[o],-1===ko.utils.arrayIndexOf(i,u.id)&&p.push(u);return p}}(this))),this.ruleCss=ko.computed(e(function(){var e,t;return e="",null==(t=pimatic.guiSettings())?e:(t.hideRuleName&&(e+=" hideRuleName"),t.hideRuleText&&(e+=" hideRuleText"),e)})),pimatic.fixedAddElement(this.enabledEditing,this.isSortingRules,$("#add-rule"),$("#rules"))}return i.prototype.enabledEditing=ko.observable(!1),i.prototype.isSortingRules=ko.observable(!1),i.prototype.afterRenderRule=function(e,t){var i;return i=$("#sortable-handle-template").text(),$(e).find("a").before($(i))},i.prototype.toggleEditing=function(){return this.enabledEditing(!this.enabledEditing())},i.prototype.onRulesSorted=function(e,t,i){var r,o,n,a,u,l,s;if(r=function(t,i){var r,o;return-1===(o=null==i?0:ko.utils.arrayIndexOf(t.rules(),i.id)+1)&&(o=0),r=t.id,pimatic.client.rest.addRuleToGroup({ruleId:e.id,groupId:r,position:o}).done(ajaxShowToast).fail(ajaxAlertFail)},a=function(t){var i;return i=t.id,pimatic.client.rest.removeRuleFromGroup({ruleId:e.id,groupId:i}).done(ajaxShowToast).fail(ajaxAlertFail)},s=function(t){return function(i){var r,o,n,a,u;for(u=[],null==i&&u.push(e.id),r=0,o=(a=t.rules()).length;r<o;r++)(n=a[r])!==e&&(u.push(n.id),null!=i&&n===i&&u.push(e.id));return pimatic.client.rest.updateRuleOrder({ruleOrder:u}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this),l=function(t,i){var r,o,n,a,u;for(u=[],null==i&&u.push(e.id),r=0,o=(n=t.rules()).length;r<o;r++)(a=n[r])!==e.id&&(u.push(a),null!=i&&a===i.id&&u.push(e.id));return pimatic.client.rest.updateGroup({groupId:t.id,group:{rulesOrder:u}}).done(ajaxShowToast).fail(ajaxAlertFail)},null!=t)return o=t instanceof pimatic.Rule?t.group():t instanceof pimatic.Group?t:null,u=t instanceof pimatic.Rule?t:void 0,n=e.group(),o!==n?null!=o?r(o,u):null!=n?a(n):s(u):null!=o?l(o,u):s(u)},i.prototype.onDropRuleOnTrash=function(e){if(confirm(__("Do you really want to delete the %s rule?",e.name())))return function(){return pimatic.loading("deleterule","show",{text:__("Saving")}),pimatic.client.rest.removeRule({ruleId:e.id}).always(function(){return pimatic.loading("deleterule","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)}()},i.prototype.toggleGroup=function(e){var t;return(t=this.collapsedGroups())[e.id]?delete t[e.id]:t[e.id]=!0,this.collapsedGroups(t),this.saveCollapseState(),!1},i.prototype.isGroupCollapsed=function(e){return!0===this.collapsedGroups()[e.id]},i.prototype.onAddRuleClicked=function(){return jQuery.mobile.pageParams={action:"add"},!0},i.prototype.onEditRuleClicked=function(e){return this.hasPermission("rules","write")||pimatic.isDemo()?(jQuery.mobile.pageParams={action:"update",rule:e},!0):(pimatic.showToast(__("Sorry, you have no permissions to edit this rule.")),!1)},i.prototype.saveCollapseState=function(){var e;return e=pimatic.storage.get("pimatic.rules")||{},e.collapsed=this.collapsedGroups(),pimatic.storage.set("pimatic.rules",e)},i}(),pimatic.pages.rules=new r})),$(document).on("pagecreate","#rules-page",e(function(e){var t,i,r;r=pimatic.pages.rules;try{ko.applyBindings(r,$("#rules-page")[0])}catch(e){t=e,TraceKit.report(t),null!=(i=pimatic.storage)&&i.removeAll(),window.location.reload()}$("#rules .handle").disableSelection()})),$(document).on("pagebeforeshow","#rules-page",e(function(e){return pimatic.try(function(){return $("#rules").listview("refresh").addClass("dark-background")})}))}).call(this);