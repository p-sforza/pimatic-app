(function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}};e=pimatic.tryCatch,$(document).on("pagebeforecreate","#variables-page",e(function(i){var a;return a=function(){function i(){this.saveCollapseState=t(this.saveCollapseState,this),this.isGroupCollapsedDA=t(this.isGroupCollapsedDA,this),this.isGroupCollapsed=t(this.isGroupCollapsed,this),this.toggleGroupDA=t(this.toggleGroupDA,this),this.toggleGroup=t(this.toggleGroup,this),this.onEditVariableClicked=t(this.onEditVariableClicked,this),this.onVariablesSorted=t(this.onVariablesSorted,this);var i;this.variables=pimatic.variables,this.groups=pimatic.groups,this.hasPermission=pimatic.hasPermission,i=pimatic.storage.get("pimatic.variables")||{},this.collapsedGroups=ko.observable(i.collapsed||{}),this.variablesListViewRefresh=ko.computed(e(function(e){return function(){var t,i,a;for(e.collapsedGroups(),e.variables(),e.enabledEditing(),t=0,i=(a=e.groups()).length;t<i;t++)a[t].variables();return pimatic.try(function(){return $("#variables").listview("refresh").addClass("dark-background")})}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),this.lockButton=ko.computed(e(function(e){return function(){var t;return t=e.enabledEditing(),{icon:t?"check":"gear"}}}(this))),this.visibleVars=ko.computed(e(function(e){return function(){return ko.utils.arrayFilter(e.variables(),function(t){return e.showAttributeVars()||!t.isDeviceAttribute()})}}(this))),this.toggleEditingText=ko.computed(e(function(e){return function(){return e.enabledEditing()?__("Lock lists"):__("Edit lists")}}(this))),this.showAttributeVarsText=ko.computed(e(function(e){return function(){return e.showAttributeVars()?__("Hide device attribute variables"):__("Show device attribute variables")}}(this))),this.getUngroupedVariables=ko.computed(e(function(e){return function(){var t,i,a,r,o,n,s,l,u,p;for(u=[],i=[],a=0,o=(s=e.groups()).length;a<o;a++)t=s[a],i=i.concat(t.variables());for(r=0,n=(l=e.variables()).length;r<n;r++)(p=l[r]).isDeviceAttribute()||-1===ko.utils.arrayIndexOf(i,p.name)&&u.push(p);return u}}(this))),this.getDeviceAttributeVariables=ko.computed(e(function(e){return function(){var t;return function(){var e,i,a,r;for(r=[],e=0,i=(a=this.variables()).length;e<i;e++)(t=a[e]).isDeviceAttribute()&&r.push(t);return r}.call(e)}}(this))),pimatic.fixedAddElement(this.enabledEditing,this.isSortingVariables,$("#add-a-variable"),$("#variables"))}return i.prototype.enabledEditing=ko.observable(!1),i.prototype.isSortingVariables=ko.observable(!1),i.prototype.showAttributeVars=ko.observable(!1),i.prototype.afterRenderVariable=function(e){var t;return t=$("#sortable-handle-template").text(),$(e).find("a").before($(t))},i.prototype.toggleEditing=function(){return this.enabledEditing(!this.enabledEditing())},i.prototype.onVariablesSorted=function(e,t,i){var a,r,o,n,s,l,u;if(a=function(t,i){var a,r;return-1===(r=null==i?0:ko.utils.arrayIndexOf(t.variables(),i.name)+1)&&(r=0),a=t.id,pimatic.client.rest.addVariableToGroup({variableName:e.name,groupId:a,position:r}).done(ajaxShowToast).fail(ajaxAlertFail)},n=function(t){var i;return i=t.id,pimatic.client.rest.removeVariableFromGroup({variableName:e.name,groupId:i}).done(ajaxShowToast).fail(ajaxAlertFail)},l=function(t){return function(i){var a,r,o,n,s;for(s=[],null==i&&s.push(e.name),a=0,r=(o=t.variables()).length;a<r;a++)(n=o[a])!==e&&(s.push(n.iname),null!=i&&n===i&&s.push(e.name));return pimatic.client.rest.updateVariableOrder({variableOrder:s}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this),s=function(t,i){var a,r,o,n,s;for(s=[],null==i&&s.push(e.name),a=0,r=(o=t.variables()).length;a<r;a++)(n=o[a])!==e.name&&(s.push(n),null!=i&&n===i.name&&s.push(e.name));return pimatic.client.rest.updateGroup({groupId:t.id,group:{variablesOrder:s}}).done(ajaxShowToast).fail(ajaxAlertFail)},null!=t)return r=t instanceof pimatic.Variable?t.group():t instanceof pimatic.Group?t:null,u=t instanceof pimatic.Variable?t:void 0,o=e.group(),r!==o?null!=r?a(r,u):null!=o?n(o):l(u):null!=r?s(r,u):l(u)},i.prototype.onDropVariableOnTrash=function(e){if(confirm(__("Do you really want to delete the variable %s?",e.name)))return function(t){return function(){return pimatic.loading("deletevariable","show",{text:__("Saving")}),pimatic.client.rest.removeVariable({name:e.name}).done(function(i){if(i.success)return t.variables.remove(e)}).always(function(){return pimatic.loading("deletevariable","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this)()},i.prototype.onAddVariableClicked=function(){return jQuery.mobile.pageParams={action:"add"},!0},i.prototype.onEditVariableClicked=function(e){return this.hasPermission("variables","write")||pimatic.isDemo()?!e.isDeviceAttribute()&&(jQuery.mobile.pageParams={action:"update",variable:e},!0):(pimatic.showToast(__("Sorry, you have no permissions to edit this variable.")),!1)},i.prototype.toggleGroup=function(e){var t;return(t=this.collapsedGroups())[e.id]?delete t[e.id]:t[e.id]=!0,this.collapsedGroups(t),this.saveCollapseState(),!1},i.prototype.toggleGroupDA=function(){return this.toggleGroup({id:"$da"})},i.prototype.isGroupCollapsed=function(e){return!0===this.collapsedGroups()[e.id]},i.prototype.isGroupCollapsedDA=function(){return this.isGroupCollapsed({id:"$da"})},i.prototype.saveCollapseState=function(){var e;return e=pimatic.storage.get("pimatic.variables")||{},e.collapsed=this.collapsedGroups(),pimatic.storage.set("pimatic.variables",e)},i}(),pimatic.pages.variables=new a})),$(document).on("pagecreate","#variables-page",e(function(e){var t,i,a;a=pimatic.pages.variables;try{ko.applyBindings(a,$("#variables-page")[0])}catch(e){t=e,TraceKit.report(t),null!=(i=pimatic.storage)&&i.removeAll(),window.location.reload()}$("#variables .handle").disableSelection()})),$(document).on("pagebeforeshow","#variables-page",e(function(e){return pimatic.try(function(){return $("#variables").listview("refresh").addClass("dark-background")})}))}).call(this);