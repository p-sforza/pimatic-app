(function(){var t,e=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1};t=pimatic.tryCatch,$(document).on("pagecreate","#events-page",t(function(n){var i,r,a,u;i=function(){function t(t){this.data=t,this.device=ko.computed(function(t){return function(){return pimatic.getDeviceById(t.data.deviceId)}}(this)).extend({rateLimit:{timeout:10,method:"notifyAtFixedRate"}}),this.attribute=ko.computed(function(t){return function(){return null!=t.device()?t.device().getAttribute(t.data.attributeName):null}}(this))}return t.prototype.formatedTime=function(){var t,e,n,i;return n=function(t){return t<10?"0"+t:""+t},t=new Date(this.data.time),e=n(t.getDate())+"."+n(t.getMonth()+1)+"."+t.getFullYear(),i=n(t.getHours())+":"+n(t.getMinutes())+":"+n(t.getSeconds()),'<span class="date">'+e+'</span> \n<span class="time">'+i+"</span>"},t.prototype.formatedValue=function(){return null!=this.attribute()?this.attribute().formatValue(this.data.value):this.data.value},t.prototype.formatedDeviceName=function(){return null!=this.device()?'<span class="device-name">'+this.device().name()+'</span> \n<span class="device-id">('+this.data.deviceId+")</span>":this.data.deviceId},t.prototype.formatedAttributeName=function(){return null!=this.attribute()?this.attribute().label:this.data.attributeName},t}(),r=function(){function n(){this.updateFromJs([]),this.displayedEvents=ko.computed(function(t){return function(){var e,n,i,r;return r=t.events(),n=t.chosenDevice(),e=t.chosenAttribute(),function(){var t,a,u;for(u=[],t=0,a=r.length;t<a;t++)i=r[t],"All"!==n&&n!==i.data.deviceId||"All"!==e&&e!==i.data.attributeName||u.push(i);return u}()}}(this)).extend({rateLimit:{timeout:10,method:"notifyAtFixedRate"}}),ko.computed(function(t){return function(){return t.chosenDevice(),t.chosenAttribute(),t.loadEvents()}}(this)),this.eventsCountText=ko.computed(function(t){return function(){var e;return null!=(e=t.eventsCount())?__("Showing %s of %s Events",t.displayedEvents().length,e):""}}(this)),this.updateListView=ko.computed(function(t){return function(){return t.displayedEvents(),pimatic.try(function(){return $("#events-table").table("refresh")})}}(this)).extend({rateLimit:{timeout:10,method:"notifyAtFixedRate"}}),pimatic.socket.on("deviceAttributeChanged",function(t){return function(e){if(null!=t.events)return t.events.unshift(new i({time:e.time,deviceId:e.deviceId,attributeName:e.attributeName,value:e.value})),t.eventsCount(t.eventsCount()+1)}}(this))}return n.mapping={$default:"ignore",events:{$key:function(t){return t.time+"-"+t.deviceId+"-"+t.attributeName},$itemOptions:{$handler:"callback",$create:function(t){return new i(t)},$update:function(t,e){return e}}}},n.prototype.devices=ko.observableArray(["All"]),n.prototype.chosenDevice=ko.observable(),n.prototype.attributes=ko.observableArray(["All"]),n.prototype.chosenAttribute=ko.observable(),n.prototype.eventsCount=ko.observable(null),n.prototype.updateFromJs=function(t){return ko.mapper.fromJS({events:t},n.mapping,this)},n.prototype.loadEvents=function(){var n;return n=function(n){return function(){var i;if(null==n.loadEventsAjax)return pimatic.loading("loading events","show",{text:__("Loading Events")}),i={limit:50,order:"time",orderDirection:"DESC"},"All"!==n.chosenDevice()&&(i.deviceId=n.chosenDevice()),"All"!==n.chosenAttribute()&&(i.attributeName=n.chosenAttribute()),pimatic.client.rest.queryDeviceAttributeEvents({criteria:i},{timeout:6e4,global:!1}).always(function(){return pimatic.loading("loading events","hide")}).done(t(function(t){var i,r,a,u,o,s;if(n.loadEventsAjax=null,t.success){for(i=0,a=(u=t.events).length;i<a;i++)o=(r=u[i]).deviceId,e.call(n.devices(),o)<0&&n.devices.push(r.deviceId),s=r.attributeName,e.call(n.attributes(),s)<0&&n.attributes.push(r.attributeName);n.updateFromJs(t.events)}})).fail(ajaxAlertFail)}}(this),null==this.loadEventsAjax?n():this.loadEventsAjax.done(function(){return n()})},n.prototype.loadEventsMeta=function(){return pimatic.client.rest.queryDeviceAttributeEventsDevices({}).done(t(function(t){return function(n){var i,r,a,u,o,s,c;if(n.success){for(c=[],i=0,a=(u=n.devices).length;i<a;i++)o=(r=u[i]).deviceId,e.call(t.devices(),o)<0&&t.devices.push(r.deviceId),s=r.attributeName,e.call(t.attributes(),s)<0?c.push(t.attributes.push(r.attributeName)):c.push(void 0);return c}}}(this))),pimatic.client.rest.queryDeviceAttributeEventsCount({}).done(t(function(t){return function(e){if(e.success)return t.eventsCount(e.count)}}(this)))},n}();try{pimatic.pages.events=u=new r,ko.applyBindings(u,$("#events-page")[0])}catch(t){a=t,TraceKit.report(a)}})),$(document).on("pagebeforeshow","#events-page",t(function(t){var e;try{return pimatic.pages.events.loadEvents(),pimatic.pages.events.loadEventsMeta()}catch(t){return e=t,TraceKit.report(e)}}))}).call(this);