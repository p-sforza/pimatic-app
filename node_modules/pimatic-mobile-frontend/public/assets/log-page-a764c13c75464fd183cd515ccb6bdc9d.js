(function(){var e,t=[].indexOf||function(e){for(var t=0,s=this.length;t<s;t++)if(t in this&&this[t]===e)return t;return-1};e=pimatic.tryCatch,$(document).on("pagecreate","#log-page",e(function(s){var a,i,n;a=function(){function s(){this.hasPermission=pimatic.hasPermission,this.updateFromJs([]),this.displayedMessages=ko.computed(function(e){return function(){var s,a,i,n;return s=e.chosenLevels(),a=e.chosenTag(),n=e.messages(),function(){var e,r,o,l;for(l=[],e=0,r=n.length;e<r;e++)o=(i=n[e]).level,t.call(s,o)>=0&&("All"===a||t.call(i.tags,a)>=0)&&l.push(i);return l}()}}(this)).extend({rateLimit:{timeout:10,method:"notifyAtFixedRate"}}),ko.computed(function(e){return function(){return e.chosenLevels(),e.chosenTag(),e.loadMessages()}}(this)),this.messageCountText=ko.computed(function(e){return function(){var t;return null!=(t=e.messageCount())?__("Showing %s of %s Messages",e.displayedMessages().length,t):""}}(this)),this.updateListView=ko.computed(function(e){return function(){return e.displayedMessages(),$("#log-messages").listview("refresh")}}(this)),pimatic.socket.on("messageLogged",e(function(e){return function(t){return e.messages.unshift({tags:t.meta.tags,level:t.level,text:t.msg,time:t.meta.timestamp})}}(this)))}return s.mapping={$default:"ignore",messages:{$key:"id",$itemOptions:{$handler:"copy"}}},s.prototype.chosenLevels=ko.observableArray(["info","warn","error"]),s.prototype.tags=ko.observableArray(["All","pimatic"]),s.prototype.chosenTag=ko.observableArray([]),s.prototype.messageCount=ko.observable(null),s.prototype.updateFromJs=function(e){return ko.mapper.fromJS({messages:e},s.mapping,this)},s.prototype.timeToShow=function(e){var t,s,a,i,n,r,o,l,u;return e=e(),a=this.displayedMessages(),0===e?null==(n=a[e])?"":(i=pimatic.timestampToDateTime(null!=n?n.time:void 0)).date+" "+i.time:(l=[a[e-1],a[e]],r=l[0],o=l[1],u=[pimatic.timestampToDateTime(r.time),pimatic.timestampToDateTime(o.time)],t=u[0],(s=u[1]).date===t.date?s.time:s.date+" "+s.time)},s.prototype.orderedInsert=function(e,t){var s,a,i,n,r;for(this.list=e,n=-1,a=s=0,i=(r=this.list).length;s<i;a=++s)if(r[a]>=t){n=a;break}return-1===n?this.list.push(t):this.list.splice(a,0,t)},s.prototype.loadMessages=function(){var s;return s=function(s){return function(){var a;if(null==s.loadMessagesAjax)return pimatic.loading("loading message","show",{text:__("Loading Messages")}),a={level:s.chosenLevels(),limit:100},"All"!==s.chosenTag()&&(a.tags=s.chosenTag()),pimatic.client.rest.queryMessages({criteria:a},{timeout:6e4,global:!1}).always(function(){return pimatic.loading("loading message","hide")}).done(e(function(e){var a,i,n,r,o,l,u;if(s.loadMessagesAjax=null,e.success)for(s.updateFromJs(e.messages),a=0,n=(o=e.messages).length;a<n;a++)for(i=0,r=(l=o[a].tags).length;i<r;i++)u=l[i],t.call(s.tags(),u)<0&&s.orderedInsert(s.tags,u)})).fail(ajaxAlertFail)}}(this),null==this.loadMessagesAjax?s():this.loadMessagesAjax.done(function(){return s()})},s.prototype.loadMessagesMeta=function(){return pimatic.client.rest.queryMessagesTags({criteria:{}}).done(e(function(e){return function(s){var a,i,n,r,o;if(s.success){for(r=[],a=0,i=(n=s.tags).length;a<i;a++)o=n[a],t.call(e.tags(),o)<0?r.push(e.orderedInsert(e.tags,o)):r.push(void 0);return r}}}(this))),pimatic.client.rest.queryMessagesCount({criteria:{}}).done(e(function(e){return function(t){if(t.success)return e.messageCount(t.count)}}(this)))},s}();try{pimatic.pages.log=n=new a,pimatic.socket.on("log",e(function(e){var t;return null!=(t=n.messageCount())&&n.messageCount(t+1),n.messages.unshift(e)})),$("#log-page").on("click","#clear-log",e(function(t,s){return n.messages[n.messages.length-1],pimatic.client.rest.deleteMessages({criteria:{}}).done(e(function(){var e,t;return n.messages.removeAll(),null!=(e=pimatic.pages)&&null!=(t=e.index)&&t.errorCount(0),n.messageCount(0)})).fail(ajaxAlertFail)})),ko.applyBindings(n,$("#log-page")[0])}catch(e){i=e,TraceKit.report(i)}})),$(document).on("pagebeforeshow","#log-page",e(function(e){var t,s;try{return s=pimatic.pages.log,null!=jQuery.mobile.pageParams&&(jQuery.mobile.pageParams.selectErrors&&s.chosenLevels(["error"]),jQuery.mobile.pageParams=null),s.loadMessages(),s.loadMessagesMeta()}catch(e){return t=e,TraceKit.report(t)}}))}).call(this);