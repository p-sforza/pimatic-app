(function(){var e;e=pimatic.tryCatch,$(document).on("pagebeforecreate",function(t){var i;if(null==pimatic.socket)return pimatic.socket=io(document.location.host+"/",{reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:3e3,timeout:2e4,forceNew:!0}),pimatic.socket.io.on("open",function(){var e;if(pimatic.loading("socket","hide"),null!=window.applicationCache)try{return window.applicationCache.update()}catch(t){return e=t,console.log(e)}}),i=0,pimatic.socket.on("connect",function(){var e;return pimatic.loading("socket","hide"),null!=(e=pimatic.pages.login)&&e.hideLoginDialog(),i=0,pimatic.socket.emit("call",{id:"errorMessageCount",action:"queryMessagesCount",params:{criteria:{level:"error"}}}),pimatic.socket.emit("call",{id:"guiSettings",action:"getGuiSettings",params:{}}),pimatic.socket.emit("call",{id:"updateProcessStatus",action:"getUpdateProcessStatus",params:{}})}),pimatic.socket.on("callResult",function(e){var t,i,n,o,c;switch(e.id){case"errorMessageCount":if(e.success)return pimatic.errorCount(e.result.count);break;case"guiSettings":if(e.success){o=(t=e.result.guiSettings).defaults;for(n in o)c=o[n],null==t.config[n]&&(t.config[n]=c);return pimatic.guiSettings(t.config)}break;case"updateProcessStatus":return i=e.result.info,pimatic.updateProcessStatus(i.status),pimatic.updateProcessMessages(i.messages)}}),pimatic.socket.on("hello",e(function(e){return pimatic.username(e.username),pimatic.role(e.role),pimatic.permissions(e.permissions)})),pimatic.socket.on("devices",e(function(e){return pimatic.updateFromJs({devices:e})})),pimatic.socket.on("rules",e(function(e){return pimatic.updateFromJs({rules:e})})),pimatic.socket.on("variables",e(function(e){return pimatic.updateFromJs({variables:e})})),pimatic.socket.on("pages",e(function(e){return pimatic.updateFromJs({devicepages:e})})),pimatic.socket.on("groups",e(function(e){return pimatic.updateFromJs({groups:e})})),pimatic.socket.on("deviceAttributeChanged",function(e){return pimatic.updateDeviceAttribute(e.deviceId,e.attributeName,e.time,e.value)}),pimatic.socket.on("deviceOrderChanged",e(function(e){return pimatic.updateDeviceOrder(e)})),pimatic.socket.on("deviceChanged",e(function(e){return pimatic.updateDeviceFromJs(e)})),pimatic.socket.on("deviceRemoved",e(function(e){return pimatic.removeDevice(e.id)})),pimatic.socket.on("deviceAdded",e(function(e){return pimatic.updateDeviceFromJs(e)})),pimatic.socket.on("pageChanged",e(function(e){return pimatic.updatePageFromJs(e)})),pimatic.socket.on("pageRemoved",e(function(e){return pimatic.removePage(e.id)})),pimatic.socket.on("pageAdded",e(function(e){return pimatic.updatePageFromJs(e)})),pimatic.socket.on("pageOrderChanged",e(function(e){return pimatic.updatePageOrder(e)})),pimatic.socket.on("groupChanged",e(function(e){return pimatic.updateGroupFromJs(e)})),pimatic.socket.on("groupRemoved",e(function(e){return pimatic.removeGroup(e.id)})),pimatic.socket.on("groupAdded",e(function(e){return pimatic.updateGroupFromJs(e)})),pimatic.socket.on("groupOrderChanged",e(function(e){return pimatic.updateGroupOrder(e)})),pimatic.socket.on("ruleAdded",e(function(e){return pimatic.updateRuleFromJs(e)})),pimatic.socket.on("ruleChanged",e(function(e){return pimatic.updateRuleFromJs(e)})),pimatic.socket.on("ruleRemoved",e(function(e){return pimatic.removeRule(e.id)})),pimatic.socket.on("ruleOrderChanged",e(function(e){return pimatic.updateRuleOrder(e)})),pimatic.socket.on("variableAdded",e(function(e){return pimatic.updateVariableFromJs(e)})),pimatic.socket.on("variableChanged",e(function(e){return pimatic.updateVariableFromJs(e)})),pimatic.socket.on("variableValueChanged",e(function(e){return pimatic.updateVariableValue(e.variableName,e.variableValue)})),pimatic.socket.on("variableRemoved",e(function(e){return pimatic.removeVariable(e.name)})),pimatic.socket.on("variableOrderChanged",e(function(e){return pimatic.updateVariableOrder(e)})),pimatic.socket.on("updateProcessStatus",e(function(e){return pimatic.updateProcessStatus(e.status)})),pimatic.socket.on("updateProcessMessage",e(function(e){return pimatic.updateProcessMessages.push(e.message)})),pimatic.socket.on("messageLogged",e(function(e){if("debug"!==e.level&&pimatic.try(function(){return pimatic.showToast(e.msg)}),"error"===e.level)return pimatic.errorCount(pimatic.errorCount()+1)})),pimatic.loading("socket","show",{text:__("Connecting"),blocking:!1}),pimatic.socket.io.on("reconnect_attempt",function(){return pimatic.loading("socket","show",{text:__("Reconnecting"),blocking:!1})}),pimatic.socket.io.on("connect_error",function(e){return pimatic.loading("socket","show",{text:__("Could not connect (%s), retrying",e.message),blocking:!1})}),pimatic.socket.io.on("connect_timeout",function(){return pimatic.loading("socket","show",{text:__("Connect timed out"),blocking:!1})}),pimatic.socket.io.on("close",function(){if(!0===pimatic.socket.io.reconnection())return pimatic.socket.io.reconnect()}),pimatic.socket.on("error",function(e){var t;return i++,"Authentication error"===e&&null!=(null!=(t=pimatic.pages)?t.login:void 0)?(pimatic.socket.io.reconnection(!1),pimatic.socket.io.disconnect(),pimatic.pages.login.showLoginDialog()):(pimatic.socket.io.disconnect(),pimatic.loading("socket","show",{text:__("Connection lost: %s",e),blocking:!1}))}),function(){var e,t,i,n;if(t=null,n=null,i=null,e=function(){document[t]?(clearTimeout(i),i=setTimeout(function(){return pimatic.socket.io.reconnection(!1),pimatic.socket.io.disconnect()},1e4)):(clearTimeout(i),pimatic.socket.io.reconnection(!0),pimatic.socket.connected||(pimatic.loading("socket","show",{text:__("Reconnecting"),blocking:!1}),pimatic.socket.io.connect()))},null!=document.hidden?(t="hidden",n="visibilitychange"):null!=document.mozHidden?(t="mozHidden",n="mozvisibilitychange"):null!=document.msHidden?(t="msHidden",n="msvisibilitychange"):null!=document.webkitHidden&&(t="webkitHidden",n="webkitvisibilitychange"),null!=document.addEventListener&&null!=document[t])return document.addEventListener(n,e,!1)}()})}).call(this);